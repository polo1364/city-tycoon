<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Â§ßÂØåÁøÅ - ÂÖ®Ëû¢ÂπïÂÑ™ÂåñÁâà</title>
  <style>
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; width: 100%; overflow: hidden; }
body {
  font-family: "Noto Sans TC", "Microsoft JhengHei", system-ui, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
}

#game-container {
  width: min(98vh, 98vw);
  height: min(98vh, 98vw);
  position: relative;
}

.board {
  width: 100%;
  height: 100%;
  background: #fff;
  border: 3px solid #333;
  border-radius: 8px;
  display: grid;
  grid-template-columns: repeat(11, 1fr);
  grid-template-rows: repeat(11, 1fr);
  position: relative;
  box-shadow: 0 10px 40px rgba(0,0,0,0.4);
}

.tile {
  border: 1px solid #ccc;
  position: relative;
  padding: 2px;
  background: #fafbff;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  font-size: clamp(7px, 0.8vw, 10px);
  overflow: hidden;
}
.tile.corner { background: #f1f3f9; font-weight: 700; }
.tile .label { font-size: clamp(7px, 0.8vw, 11px); font-weight: 600; line-height: 1.1; word-break: break-all; }
.tile .price { font-size: clamp(6px, 0.6vw, 9px); color: #666; }
.tile .badge { position: absolute; top: 0; left: 0; padding: 1px 2px; font-size: clamp(6px, 0.6vw, 8px); background: #333; color: #fff; border-bottom-right-radius: 3px; }
.tile .owner { 
  position: absolute; 
  right: 4px; 
  bottom: 4px; 
  width: clamp(18px, 2vw, 26px); 
  height: clamp(18px, 2vw, 26px); 
  border-radius: 50%; 
  border: 3px solid #fff; 
  box-shadow: 0 3px 10px rgba(0,0,0,0.8), inset 0 2px 4px rgba(255,255,255,0.4), 0 0 0 1px rgba(0,0,0,0.3); 
  z-index: 12; 
}
.tile .level-badge { 
  position: absolute; 
  left: 4px; 
  top: 4px; 
  background: linear-gradient(135deg, #10b981 0%, #059669 100%); 
  color: #fff; 
  font-size: clamp(10px, 1.1vw, 15px); 
  font-weight: 900; 
  padding: 3px 6px; 
  border-radius: 5px; 
  line-height: 1; 
  z-index: 12;
  box-shadow: 0 3px 8px rgba(0,0,0,0.5), 0 0 0 2px rgba(255,255,255,0.4);
  border: 2px solid rgba(255,255,255,0.6);
  letter-spacing: 0.5px;
}
.tile .level-badge.hotel { 
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); 
}
.tile.property .colorbar { height: clamp(3px, 0.4vw, 6px); border-radius: 2px; margin-bottom: 1px; }
.tile.station::after, .tile.utility::after, .tile.tax::after, .tile.chance::after, 
.tile.chest::after, .tile.gotojail::after, .tile.jail::after, .tile.start::after, .tile.free::after {
  position: absolute; right: 1px; top: 1px; font-size: clamp(10px, 1.2vw, 14px);
}
.tile.station::after { content: "üöâ"; }
.tile.utility::after { content: "‚öôÔ∏è"; }
.tile.tax::after { content: "üí∞"; }
.tile.chance::after { content: "üé≤"; }
.tile.chest::after { content: "üÇ†"; }
.tile.gotojail::after { content: "üöî"; }
.tile.jail::after { content: "üß±"; }
.tile.start::after { content: "üèÅ"; }
.tile.free::after { content: "üÖøÔ∏è"; }

.token {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: clamp(14px, 1.5vw, 18px);
  font-weight: 700;
  color: white;
  text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  width: clamp(40px, 3.5vw, 50px); /* ÊèêÈ´òÊúÄÂ∞èÂØ¨Â∫¶ */
  height: clamp(40px, 3.5vw, 50px); /* ÊèêÈ´òÊúÄÂ∞èÈ´òÂ∫¶ */
  border-radius: 50%;
  border: 3px solid #fff;
  box-shadow: 0 6px 16px rgba(0,0,0,0.8), 0 0 20px rgba(255,255,255,0.4), 0 0 0 3px rgba(0,0,0,0.3);
  position: absolute;
  bottom: 50%;
  left: 50%;
  transform: translate(calc(-50% + var(--tx, 0)), calc(-50% + var(--ty, 0)));
  display: grid;
  place-items: center;
  color: #fff;
  text-shadow: 0 0 6px rgba(0,0,0,0.8), 0 2px 4px rgba(0,0,0,0.6);
  font-size: clamp(12px, 1.4vw, 17px);
  font-weight: 900;
  line-height: 1;
  white-space: nowrap;
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  z-index: 120; /* ÊèêÈ´òÊ£ãÂ≠êÁöÑ z-index */
  animation: tokenGlow 2s ease-in-out infinite;
}
.token[data-p="0"] { --tx: 0px; --ty: 0px; }
.token[data-p="1"] { --tx: clamp(8px, 1vw, 12px); --ty: clamp(8px, 1vw, 12px); }
.token[data-p="2"] { --tx: clamp(-8px, -1vw, -12px); --ty: clamp(8px, 1vw, 12px); }
.token[data-p="3"] { --tx: clamp(8px, 1vw, 12px); --ty: clamp(-8px, -1vw, -12px); }

.token.moving {
  transform: translate(calc(-50% + var(--tx, 0)), calc(-50% + var(--ty, 0))) scale(2.5);
  z-index: 30;
  filter: drop-shadow(0 0 30px currentColor) drop-shadow(0 0 60px currentColor);
  animation: pulse 0.4s ease-in-out infinite;
}
@keyframes pulse {
  0%, 100% { transform: translate(calc(-50% + var(--tx, 0)), calc(-50% + var(--ty, 0))) scale(2.5); }
  50% { transform: translate(calc(-50% + var(--tx, 0)), calc(-50% + var(--ty, 0))) scale(2.8); }
}

@keyframes tokenGlow {
  0%, 100% { 
    transform: translate(calc(-50% + var(--tx, 0)), calc(-50% + var(--ty, 0))) scale(1); 
    box-shadow: 0 6px 16px rgba(0,0,0,0.8), 0 0 20px rgba(255,255,255,0.4), 0 0 0 3px rgba(0,0,0,0.3);
  }
  50% { 
    transform: translate(calc(-50% + var(--tx, 0)), calc(-50% + var(--ty, 0))) scale(1.15); 
    box-shadow: 0 8px 20px rgba(0,0,0,0.9), 0 0 30px rgba(255,255,255,0.6), 0 0 0 3px rgba(0,0,0,0.3);
  }
}

.house-stack { position: absolute; left: 2px; top: 2px; display: flex; gap: 1px; z-index: 5; }
.house { width: clamp(5px, 0.6vw, 8px); height: clamp(4px, 0.5vw, 6px); background: #10b981; border: 1px solid rgba(0,0,0,0.2); border-radius: 1px; }
.hotel { width: clamp(7px, 0.8vw, 10px); height: clamp(5px, 0.6vw, 8px); background: #ef4444; border: 1px solid rgba(0,0,0,0.3); border-radius: 2px; }

.center-panel {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 63.6%;
  height: 63.6%;
  background: rgba(255, 255, 255, 0.96);
  border-radius: 16px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  display: flex;
  flex-direction: column;
  padding: 20px;
  z-index: 100;
  transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.center-panel.minimized {
  width: 25%;
  height: 25%;
  opacity: 0.2;
  pointer-events: none;
  transform: translate(-50%, -50%) scale(0.8);
}

.center-panel.collapsed {
  width: auto;
  height: auto;
  padding: 6px 10px;
}

.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-bottom: 6px;
  border-bottom: 2px solid #ddd;
  flex-shrink: 0;
}
.panel-header h1 {
  font-size: clamp(12px, 1.4vw, 18px);
  color: #333;
  font-weight: 700;
}
.panel-toggle {
  background: #667eea;
  color: #fff;
  border: none;
  padding: 4px 8px;
  border-radius: 5px;
  cursor: pointer;
  font-size: clamp(10px, 1.1vw, 13px);
  font-weight: 600;
  transition: background 0.2s;
}
.panel-toggle:hover { background: #5568d3; }

.panel-content {
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: clamp(6px, 0.8vw, 10px);
}
.panel-content.hidden { display: none; }

.section {
  background: #f8f9fa;
  padding: clamp(6px, 0.8vw, 10px);
  border-radius: 6px;
  border: 1px solid #dee2e6;
}
.section h2 {
  font-size: clamp(11px, 1.2vw, 15px);
  margin-bottom: 6px;
  color: #495057;
  font-weight: 700;
}

.top-section {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: clamp(6px, 0.8vw, 10px);
  padding: 0 !important;
  background: transparent !important;
  border: none !important;
}
.current-player-area, .players-area {
  background: #f8f9fa;
  padding: clamp(6px, 0.8vw, 10px);
  border-radius: 6px;
  border: 1px solid #dee2e6;
}
.current-player-area h2, .players-area h2 {
  font-size: clamp(10px, 1.1vw, 14px);
  margin-bottom: 4px;
}
#playersPanel {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 4px;
}
#playersPanel .row {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: clamp(9px, 1vw, 11px);
  padding: 3px;
  background: white;
  border-radius: 4px;
}

.dice-container {
  display: flex;
  gap: 6px;
  align-items: center;
  margin: 4px 0;
}
.die {
  width: clamp(30px, 3.5vw, 44px);
  height: clamp(30px, 3.5vw, 44px);
  display: grid;
  place-items: center;
  border: 2px solid #495057;
  border-radius: 6px;
  background: #fff;
  font-weight: 700;
  font-size: clamp(16px, 2vw, 22px);
  box-shadow: 0 2px 4px rgba(0,0,0,0.15);
}
.turn-info {
  font-size: clamp(10px, 1.1vw, 13px);
  color: #666;
  margin-top: 4px;
}

.player-row {
  display: grid;
  grid-template-columns: clamp(10px, 1.2vw, 14px) 1fr auto;
  gap: 4px;
  align-items: center;
  padding: 2px 0;
  font-size: clamp(9px, 1vw, 12px);
}
.player-swatch {
  width: clamp(8px, 1vw, 12px);
  height: clamp(8px, 1vw, 12px);
  border-radius: 50%;
  border: 1px solid rgba(0,0,0,0.3);
}
.player-name { font-weight: 600; }
.player-cash { font-variant-numeric: tabular-nums; color: #28a745; font-weight: 600; }

.controls-section {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: clamp(4px, 0.5vw, 6px);
}
button {
  border: 1px solid #ced4da;
  background: #fff;
  color: #212529;
  padding: clamp(5px, 0.6vw, 8px) clamp(6px, 0.7vw, 10px);
  border-radius: 5px;
  cursor: pointer;
  font-size: clamp(9px, 1vw, 12px);
  font-weight: 600;
  transition: all 0.2s;
  white-space: nowrap;
}
button:disabled { opacity: 0.5; cursor: not-allowed; }
button:hover:not(:disabled) { background: #e9ecef; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
button:active:not(:disabled) { transform: translateY(0); }
button.primary { background: #2b6ef3; color: #fff; border-color: #2b6ef3; }
button.ok { background: #28a745; color: #fff; border-color: #28a745; }
button.danger { background: #dc3545; color: #fff; border-color: #dc3545; }

.log-section {
  flex: 3;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  min-height: 120px;
  max-height: 200px;
}
.log-section h2 {
  font-size: clamp(11px, 1.2vw, 15px);
  margin-bottom: 6px;
  color: #333;
}
.log-content {
  flex: 1;
  overflow-y: auto;
  font-size: clamp(9px, 1vw, 12px);
  line-height: 1.4;
  background: #f8f9fa;
  padding: 6px;
  border-radius: 6px;
  border: 1px solid #dee2e6;
}
.log-entry {
  border-top: 1px dashed #dee2e6;
  padding: 3px 0;
}
.log-entry.me {
  background: #fff3cd;
  border-left: 3px solid #ffc107;
  padding-left: 6px;
  margin-left: -6px;
}

.toast {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0, 0, 0, 0.85);
  color: #fff;
  padding: 10px 16px;
  border-radius: 8px;
  font-size: clamp(12px, 1.3vw, 16px);
  text-align: center;
  max-width: 80%;
  pointer-events: none;
  opacity: 1;
  transition: opacity 0.6s ease;
  z-index: 200;
  font-weight: 600;
}
.toast.hidden { opacity: 0; }

.modal {
  position: fixed;
  inset: 0;
  display: grid;
  place-items: center;
  background: rgba(0, 0, 0, 0.6);
  z-index: 300;
}
.modal.hidden { display: none; }
.modal-content {
  width: min(400px, 90vw);
  background: #fff;
  border-radius: 12px;
  border: 2px solid #333;
  padding: 16px;
}
.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  margin-top: 12px;
}

.drawer {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  display: grid;
  place-items: end;
  z-index: 300;
}
.drawer.hidden { display: none; }
.drawer-content {
  width: min(600px, 95vw);
  height: min(70vh, 600px);
  background: #fff;
  border-radius: 12px 12px 0 0;
  border: 2px solid #333;
  padding: 12px;
  display: grid;
  grid-template-rows: auto 1fr;
}
.drawer-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  padding-bottom: 8px;
  border-bottom: 2px solid #e0e0e0;
}
.drawer-header h3 {
  font-size: clamp(13px, 1.4vw, 17px);
  font-weight: 700;
}
#assetsBody { overflow: auto; }

.asset-table {
  width: 100%;
  border-collapse: collapse;
  font-size: clamp(10px, 1.1vw, 13px);
}
.asset-table th, .asset-table td {
  border: 1px solid #dee2e6;
  padding: 6px;
}
.asset-table th { background: #f8f9fa; font-weight: 600; }
.asset-table button {
  padding: 4px 6px;
  font-size: clamp(9px, 1vw, 11px);
}

#diag {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  padding: 6px 10px;
  font-size: clamp(10px, 1.1vw, 12px);
  background: #28a745;
  color: #fff;
  display: flex;
  gap: 8px;
  align-items: center;
  z-index: 400;
}
#diag.err { background: #dc3545; }

@media (max-width: 768px) {
  .center-panel {
    width: 85%;
    height: 60%; /* ÈÄ≤‰∏ÄÊ≠•Ê∏õÂ∞ëÈ´òÂ∫¶ */
    padding: 8px;
  }
  .panel-header h1 {
    font-size: 14px;
  }
  .top-section {
    grid-template-columns: 1fr;
    gap: 4px;
  }
  .controls-section {
    grid-template-columns: repeat(2, 1fr);
    gap: 4px;
  }
  .section {
    padding: 4px;
  }
  .section h2 {
    font-size: 12px;
    margin-bottom: 4px;
  }
  #log {
    max-height: 80px;
    font-size: 10px;
  }
  .player-card {
    padding: 4px;
    font-size: 11px;
  }
  button {
    padding: 6px 10px;
    font-size: 11px;
  }
}

@media (max-width: 480px) {
  /* ÊâãÊ©üÁâàÔºöËàáÈõªËÖ¶ÁâàÁõ∏Âêå‰ΩàÂ±ÄÔºåÂè™Á∏ÆÂ∞èÂ∞∫ÂØ∏ */
  .center-panel {
    width: 70%;
    height: 70%;
    padding: 10px;
  }
  .center-panel.collapsed {
    width: auto;
    height: auto;
    padding: 4px 8px;
  }
  .panel-header h1 {
    font-size: 14px;
  }
  .panel-toggle {
    padding: 4px 8px;
    font-size: 11px;
  }
  .section h2 {
    font-size: 11px;
  }
  #log {
    font-size: 10px;
  }
  .player-card {
    font-size: 10px;
  }
  button {
    padding: 6px 10px;
    font-size: 11px;
  }
  .tile .price { display: none; }
  /* Ê£ãÂ≠êÈ°ØÁ§∫ */
  .token {
    width: 50px !important;
    height: 50px !important;
    font-size: 20px !important;
    z-index: 500 !important;
  }
}


  
.center-panel.minimized {
  width: 25%;
  height: 25%;
  opacity: 0.2;
  pointer-events: none;
  transform: translate(-50%, -50%) scale(0.8);
}


.token.moving {
  transform: translate(calc(-50% + var(--tx, 0)), calc(-50% + var(--ty, 0))) scale(2.5);
  z-index: 30;
  filter: drop-shadow(0 0 30px currentColor) drop-shadow(0 0 60px currentColor);
  animation: pulse 0.4s ease-in-out infinite;
}
@keyframes pulse {
  0%, 100% { transform: translate(calc(-50% + var(--tx, 0)), calc(-50% + var(--ty, 0))) scale(2.5); }
  50% { transform: translate(calc(-50% + var(--tx, 0)), calc(-50% + var(--ty, 0))) scale(2.8); }
}


/* Áé©ÂÆ∂‰ΩîÈªû - Ê†ºÂ≠êËÉåÊôØËâ≤ */
.tile.owned {
  background: var(--owner-color) !important;
  opacity: 0.85;
}


/* ========== Ë¶ñË¶∫È¢®Ê†ºÂ¢ûÂº∑Ôºà‰∏çÊîπËÆä‰ΩàÂ±ÄÔºâ ========== */

/* ËÉåÊôØÁæéÂåñ */
body { 
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  position: relative;
}

body::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: 
    radial-gradient(circle at 20% 50%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(138, 43, 226, 0.1) 0%, transparent 50%);
  animation: bgMove 20s ease-in-out infinite;
  pointer-events: none;
  z-index: 0;
}

@keyframes bgMove {
  0%, 100% { transform: translate(0, 0); }
  50% { transform: translate(30px, 30px); }
}

#app {
  position: relative;
  z-index: 1;
}

/* Ê£ãÁõ§ÂÆπÂô®ÁæéÂåñ */
#boardContainer {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  border-radius: 20px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
}

/* Ê£ãÁõ§ÁæéÂåñ */
#board {
  background: rgba(255, 255, 255, 0.95);
  border-radius: 16px;
  box-shadow: 
    0 0 0 4px rgba(255, 215, 0, 0.3),
    0 0 0 8px rgba(255, 215, 0, 0.2),
    0 20px 60px rgba(0, 0, 0, 0.3);
}

/* Ê†ºÂ≠êÁæéÂåñ */
.tile {
  background: linear-gradient(145deg, #ffffff, #f0f0f0);
  transition: all 0.3s ease;
}

.tile:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  z-index: 10;
}

.tile.corner {
  background: linear-gradient(145deg, #FFD700, #FFA500);
  color: #fff;
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}

.color-bar {
  box-shadow: inset 0 -2px 4px rgba(0, 0, 0, 0.2);
}

/* ÊéßÂà∂Èù¢ÊùøÁæéÂåñ */
#panel {
  background: rgba(255, 255, 255, 0.98);
  backdrop-filter: blur(20px);
  border-radius: 20px;
  border: 2px solid rgba(255, 215, 0, 0.5);
  box-shadow: 
    0 12px 40px rgba(0, 0, 0, 0.4),
    inset 0 1px 0 rgba(255, 255, 255, 0.8);
}

#panel::-webkit-scrollbar-thumb {
  background: linear-gradient(180deg, #667eea, #764ba2);
}

/* È™∞Â≠êÂçÄÂüüÁæéÂåñ */
#diceArea {
  background: linear-gradient(145deg, #ffffff, #f5f5f5);
  border-radius: 12px;
  box-shadow: 
    0 4px 12px rgba(0, 0, 0, 0.1),
    inset 0 1px 0 rgba(255, 255, 255, 0.8);
  border: 2px solid rgba(255, 215, 0, 0.3);
}

#diceArea h3 {
  color: #667eea;
}

/* È™∞Â≠ê3DÊïàÊûú */
.dice {
  border: 3px solid #FFD700;
  border-radius: 10px;
  background: linear-gradient(145deg, #ffffff, #f0f0f0);
  box-shadow: 
    0 6px 20px rgba(0, 0, 0, 0.2),
    inset 0 2px 4px rgba(255, 255, 255, 0.8);
  color: #667eea;
  transition: all 0.3s ease;
}

.dice:hover {
  transform: rotateX(10deg) rotateY(10deg);
}

.dice.rolling {
  animation: diceRoll 0.5s ease-in-out;
}

@keyframes diceRoll {
  0% { transform: rotate(0deg) scale(1); }
  25% { transform: rotate(90deg) scale(1.1); }
  50% { transform: rotate(180deg) scale(1.2); }
  75% { transform: rotate(270deg) scale(1.1); }
  100% { transform: rotate(360deg) scale(1); }
}

/* ÊåâÈàïÁæéÂåñ */
button {
  border-radius: 10px;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

button::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.3);
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}

button:hover::before {
  width: 300px;
  height: 300px;
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
}

button:active {
  transform: translateY(0);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

#btnRoll, #btnBuy {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
}

#btnEnd, #btnSkip {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  color: white;
  border: none;
}

#btnAssets, #btnBuild, #btnCardCollection {
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  color: white;
  border: none;
}

#btnSave, #btnLoad {
  background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
  color: white;
  border: none;
}

#btnReset {
  background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
  color: white;
  border: none;
}

/* Áé©ÂÆ∂ÂçÄÂüüÁæéÂåñ */
#playersArea {
  background: linear-gradient(145deg, #ffffff, #f5f5f5);
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

#playersArea h3 {
  color: #667eea;
}

.player-card {
  background: white;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.player-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--player-color), transparent);
}

.player-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
}

.player-card.current {
  border-color: #FFD700;
  box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.3);
}

/* Êà∞Ê≥ÅÁ¥ÄÈåÑÁæéÂåñ */
#logSection {
  background: linear-gradient(145deg, #ffffff, #f5f5f5);
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

#logSection h3 {
  color: #667eea;
}

#log::before {
  content: '';
  position: absolute;
  left: 6px;
  top: 0;
  bottom: 0;
  width: 2px;
  background: linear-gradient(180deg, #667eea, #764ba2);
}

#log div::before {
  content: '';
  position: absolute;
  left: 0;
  top: 6px;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: #667eea;
  box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
}

/* Ê®°ÊÖãÊ°ÜÁæéÂåñ */
#modal {
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(8px);
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-content {
  border-radius: 20px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from { transform: translateY(50px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.modal-content h2 {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* ToastÁæéÂåñ */
.toast {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 50px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
  animation: toastSlide 0.3s ease;
}

@keyframes toastSlide {
  from { transform: translateX(-50%) translateY(-100px); opacity: 0; }
  to { transform: translateX(-50%) translateY(0); opacity: 1; }
}
</style>
</head>
<body>
  <div id="game-container">
    <section class="board" id="board">
      <div id="toast" class="toast hidden"></div>
    </section>
    
    <div class="center-panel" id="centerPanel">
        <div class="panel-header">
          <h1>üé≤ Â§ßÂØåÁøÅ</h1>
          <button class="panel-toggle" id="panelToggle">Êî∂Ëµ∑</button>
        </div>
        
        <div class="panel-content" id="panelContent">
          <div class="section top-section">
            <div class="current-player-area">
              <h2>Áï∂ÂâçÁé©ÂÆ∂</h2>
              <div id="currentPlayer"></div>
              <div class="dice-container">
                <div id="dice1" class="die">-</div>
                <div id="dice2" class="die">-</div>
              </div>
              <div class="turn-info" id="turnInfo"></div>
            </div>
            <div class="players-area">
              <h2>Áé©ÂÆ∂ÂàóË°®</h2>
              <div id="playersPanel"></div>
            </div>
          </div>
          
          <div class="section controls-section">
            <button id="btnRoll" class="primary">üé≤ Êì≤È™∞</button>
            <button id="btnBuy" class="ok" disabled>Ë≤∑‰∏ã</button>
            <button id="btnSkip" disabled>Áï•ÈÅé</button>
            <button id="btnEnd" disabled>ÁµêÊùü</button>
            <button id="btnAssets">Ë≥áÁî¢</button>
            <button id="btnBuild">üè† ÂçáÁ¥öÊàøÂ≠ê</button>
            <button id="btnCollection">üìö Âç°ÁâåÂúñÈëë</button>
            <button id="btnSave">Â≠òÊ™î</button>
            <button id="btnLoad">ËÆÄÊ™î</button>
            <button id="btnReset" class="danger">üéÆ Êñ∞ÈÅäÊà≤</button>
          </div>
          
          <div class="section log-section">
            <h2>Êà∞Ê≥ÅÁ¥ÄÈåÑ</h2>
            <div class="log-content" id="log"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="modal" class="modal hidden">
    <div class="modal-content">
      <div id="modalBody"></div>
      <div class="modal-actions">
        <button id="modalOk" class="ok">Á¢∫ÂÆö</button>
        <button id="modalCancel">ÂèñÊ∂à</button>
      </div>
    </div>
  </div>

  <div id="assetsPanel" class="drawer hidden">
    <div class="drawer-content">
      <div class="drawer-header">
        <h3>Ë≥áÁî¢ËàáÂª∫Â±ã</h3>
        <button id="btnCloseAssets">‚úï</button>
      </div>
      <div id="assetsBody"></div>
    </div>
  </div>

  <div id="diag">‚úÖ v2.3 ÂàùÂßãÂåñÂÆåÊàê„ÄÇ</div>

  <script>
window.__TYCOON_V23_READY__=true;
// ÂüéÂ∏ÇË≥áÊú¨Êà∞ Web Áâà v2.3ÔºöÊ£ãÂ≠êÁßªÂãï + 5ÊÆµÂª∫Â±ã + Á∂ìÊøüÂçáÁ¥ö + Áõ¥ÂºèÂÑ™Âåñ
"use strict";
(function(){
  var diagEl = document.getElementById('diag');
  function diagOK(msg){ if (diagEl){ diagEl.className=''; diagEl.textContent='‚úÖ '+msg; setTimeout(function(){ diagEl.style.display='none'; }, 3000); } }
  function diagERR(msg){ if (diagEl){ diagEl.className='err'; diagEl.textContent='üö® '+msg; } }

  window.addEventListener('error', function(e){ diagERR('JS ÈåØË™§Ôºö'+(e.message||e)); });
  window.addEventListener('unhandledrejection', function(e){ diagERR('Promise ÈåØË™§Ôºö'+(e.reason&&e.reason.message||e.reason)); });

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", boot); else boot();

  function boot(){ try{ window.__TYCOON_V23_READY__=true; main(); diagOK("v2.3 ÂàùÂßãÂåñÂÆåÊàê„ÄÇ"); }catch(err){ diagERR("ÂàùÂßãÂåñÂ§±ÊïóÔºö"+(err&&err.message||err)); console.error(err); } }

  function main(){

    // ========== Âú∞ÂúñÊï∏Êìö ==========
    
    // ========== ËßíËâ≤Á≥ªÁµ± ==========
    var CHARACTERS = [
      { id: 'xiaomei', name: 'Â∞èÁæé', color: '#FF6B6B', shape: 'circle', emoji: 'üëß' },
      { id: 'laobo', name: 'ËÄÅ‰ºØ', color: '#4ECDC4', shape: 'square', emoji: 'üë¥' },
      { id: 'furen', name: 'Â§´‰∫∫', color: '#95E1D3', shape: 'triangle', emoji: 'üë©' },
      { id: 'shalong', name: 'Ê≤ôÈæç', color: '#F38181', shape: 'diamond', emoji: 'üíº' },
      { id: 'jinbei', name: 'ÈáëË≤ù', color: '#FFD93D', shape: 'circle', emoji: 'üí∞' },
      { id: 'wumi', name: 'ÁÉèÂí™', color: '#6C5CE7', shape: 'square', emoji: 'üê±' },
      { id: 'renta', name: 'ÂøçÂ§™', color: '#A8E6CF', shape: 'triangle', emoji: 'ü•∑' },
      { id: 'laoqian', name: 'ËÄÅÂçÉ', color: '#FF8B94', shape: 'diamond', emoji: 'üé≤' },
      { id: 'danni', name: '‰∏πÂ∞º', color: '#FFD3B6', shape: 'circle', emoji: 'üë¶' },
      { id: 'baozang', name: 'ÂØ∂Ëóè', color: '#FFAAA5', shape: 'square', emoji: 'üó∫Ô∏è' },
      { id: 'wumei', name: 'ËàûÁæé', color: '#FF8C94', shape: 'triangle', emoji: 'üíÉ' },
      { id: 'shala', name: 'ËééÊãâ', color: '#A8D8EA', shape: 'diamond', emoji: 'üë∏' },
      { id: 'laina', name: 'ËêäÂ®ú', color: '#FFDAC1', shape: 'circle', emoji: 'üå∏' },
      { id: 'tangtang', name: 'Á≥ñÁ≥ñ', color: '#FFB7B2', shape: 'square', emoji: 'üç¨' },
      { id: 'xiaoyao', name: 'ÈÄçÈÅô', color: '#B4F8C8', shape: 'triangle', emoji: '‚öîÔ∏è' },
      { id: 'linger', name: 'ÈùàÂÖí', color: '#A0E7E5', shape: 'diamond', emoji: 'ü¶ã' },
      { id: 'yueru', name: 'ÊúàÂ¶Ç', color: '#FBE7C6', shape: 'circle', emoji: 'üåô' },
      { id: 'anu', name: 'ÈòøÂ•¥', color: '#FFAEBC', shape: 'square', emoji: 'üå∫' },
      { id: 'jingtian', name: 'ÊôØÂ§©', color: '#A0C4FF', shape: 'triangle', emoji: 'üó°Ô∏è' },
      { id: 'xia', name: 'Áëï', color: '#BDB2FF', shape: 'diamond', emoji: '‚ú®' },
      { id: 'xiahou', name: 'Â§è‰æØ', color: '#FFFFB5', shape: 'circle', emoji: 'üõ°Ô∏è' }
    ];
    var selectedPlayers = [];
    var gamePlayerCount = 4;
    
var MAPS = {
      taiwan: {
        name: "Âè∞ÁÅ£",
        properties: [
          {idx:1, name:"‰πù‰ªΩËÄÅË°ó", price:2000, group:"brown"},
          {idx:3, name:"Ê∑°Ê∞¥ÊºÅ‰∫∫Á¢ºÈ†≠", price:2000, group:"brown"},
          {idx:6, name:"ÈôΩÊòéÂ±±", price:3300, group:"lightblue"},
          {idx:8, name:"ÂåóÊäïÊ∫´Ê≥â", price:3300, group:"lightblue"},
          {idx:9, name:"ÈáéÊü≥Âú∞Ë≥™ÂÖ¨Âúí", price:4000, group:"lightblue"},
          {idx:11, name:"Â£´ÊûóÂ§úÂ∏Ç", price:4600, group:"pink"},
          {idx:13, name:"Âè∞Âåó101", price:4600, group:"pink"},
          {idx:14, name:"‰∏≠Ê≠£Á¥ÄÂøµÂ†Ç", price:5300, group:"pink"},
          {idx:16, name:"Êó•ÊúàÊΩ≠", price:6000, group:"orange"},
          {idx:18, name:"ÈòøÈáåÂ±±", price:6000, group:"orange"},
          {idx:19, name:"Ê∫™È†≠", price:6600, group:"orange"},
          {idx:21, name:"Â§™È≠ØÈñ£", price:7300, group:"red"},
          {idx:23, name:"Ê∏ÖÂ¢ÉËæ≤Â†¥", price:7300, group:"red"},
          {idx:24, name:"ÂêàÊ≠°Â±±", price:8000, group:"red"},
          {idx:26, name:"Â¢æ‰∏Å", price:8600, group:"yellow"},
          {idx:27, name:"ÈµùÈëæÈºªÁáàÂ°î", price:8600, group:"yellow"},
          {idx:29, name:"Ë≤ìÈºªÈ†≠", price:9300, group:"yellow"},
          {idx:31, name:"Á∂†Â≥∂", price:10000, group:"green"},
          {idx:32, name:"Ëò≠Â∂º", price:10000, group:"green"},
          {idx:34, name:"Â∞èÁêâÁêÉ", price:10600, group:"green"},
          {idx:37, name:"ÊæéÊπñ", price:11600, group:"darkblue"},
          {idx:39, name:"È¶¨Á•ñ", price:13200, group:"darkblue"}
        ],
        stations: [
          {idx:5, name:"Âè∞ÂåóËªäÁ´ô"},
          {idx:15, name:"Âè∞‰∏≠ËªäÁ´ô"},
          {idx:25, name:"È´òÈõÑËªäÁ´ô"},
          {idx:35, name:"Âè∞ÂçóËªäÁ´ô"}
        ],
        utilities: [
          {idx:12, name:"Âè∞ÁÅ£Ëá™‰æÜÊ∞¥ÂÖ¨Âè∏"},
          {idx:28, name:"Âè∞ÁÅ£ÈõªÂäõÂÖ¨Âè∏"}
        ]
      },
      japan: {
        name: "Êó•Êú¨",
        properties: [
          {idx:1, name:"Ê∑∫ËçâÂØ∫", price:2000, group:"brown"},
          {idx:3, name:"ÁßãËëâÂéü", price:2000, group:"brown"},
          {idx:6, name:"ÂØåÂ£´Â±±", price:3300, group:"lightblue"},
          {idx:8, name:"ÁÆ±Ê†πÊ∫´Ê≥â", price:3300, group:"lightblue"},
          {idx:9, name:"ÈéåÂÄâÂ§ß‰Ωõ", price:4000, group:"lightblue"},
          {idx:11, name:"Êù±‰∫¨ÈêµÂ°î", price:4600, group:"pink"},
          {idx:13, name:"Êô¥Á©∫Â°î", price:4600, group:"pink"},
          {idx:14, name:"ÊòéÊ≤ªÁ•ûÂÆÆ", price:5300, group:"pink"},
          {idx:16, name:"Â§ßÈò™Âüé", price:6000, group:"orange"},
          {idx:18, name:"ÈÅìÈ†ìÂ†Ä", price:6000, group:"orange"},
          {idx:19, name:"ÂøÉÈΩãÊ©ã", price:6600, group:"orange"},
          {idx:21, name:"Ê∏ÖÊ∞¥ÂØ∫", price:7300, group:"red"},
          {idx:23, name:"ÈáëÈñ£ÂØ∫", price:7300, group:"red"},
          {idx:24, name:"‰ºèË¶ãÁ®ªËç∑", price:8000, group:"red"},
          {idx:26, name:"Âö¥Â≥∂Á•ûÁ§æ", price:8600, group:"yellow"},
          {idx:27, name:"Âª£Â≥∂ÂíåÂπ≥ÂÖ¨Âúí", price:8600, group:"yellow"},
          {idx:29, name:"Âß¨Ë∑ØÂüé", price:9300, group:"yellow"},
          {idx:31, name:"Êú≠ÂπåÈõ™Á•≠", price:10000, group:"green"},
          {idx:32, name:"Â∞èÊ®ΩÈÅãÊ≤≥", price:10000, group:"green"},
          {idx:34, name:"ÂáΩÈ§®Â§úÊôØ", price:10600, group:"green"},
          {idx:37, name:"Ê≤ñÁπ©ÁæéÈ∫óÊµ∑", price:11600, group:"darkblue"},
          {idx:39, name:"È¶ñÈáåÂüé", price:13200, group:"darkblue"}
        ],
        stations: [
          {idx:5, name:"Êù±‰∫¨Á´ô"},
          {idx:15, name:"Â§ßÈò™Á´ô"},
          {idx:25, name:"‰∫¨ÈÉΩÁ´ô"},
          {idx:35, name:"ÂêçÂè§Â±ãÁ´ô"}
        ],
        utilities: [
          {idx:12, name:"Êù±‰∫¨ÈõªÂäõ"},
          {idx:28, name:"ÈóúË•øÈõªÂäõ"}
        ]
      },
      usa: {
        name: "ÁæéÂúã",
        properties: [
          {idx:1, name:"Ëá™Áî±Â•≥Á•ûÂÉè", price:2000, group:"brown"},
          {idx:3, name:"ÊôÇ‰ª£Âª£Â†¥", price:2000, group:"brown"},
          {idx:6, name:"Â§ßÂ≥ΩË∞∑", price:3300, group:"lightblue"},
          {idx:8, name:"ÈªÉÁü≥ÂÖ¨Âúí", price:3300, group:"lightblue"},
          {idx:9, name:"ÂÑ™ÂãùÁæéÂú∞", price:4000, group:"lightblue"},
          {idx:11, name:"Â•ΩËêäÂ°¢", price:4600, group:"pink"},
          {idx:13, name:"Ëø™Â£´Â∞ºÊ®ÇÂúí", price:4600, group:"pink"},
          {idx:14, name:"Áí∞ÁêÉÂΩ±Âüé", price:5300, group:"pink"},
          {idx:16, name:"ÈáëÈñÄÂ§ßÊ©ã", price:6000, group:"orange"},
          {idx:18, name:"ÊºÅ‰∫∫Á¢ºÈ†≠", price:6000, group:"orange"},
          {idx:19, name:"ÁüΩË∞∑", price:6600, group:"orange"},
          {idx:21, name:"ÊãâÊñØÁ∂≠Âä†ÊñØ", price:7300, group:"red"},
          {idx:23, name:"Â§ßÈÉΩÊúÉ", price:7300, group:"red"},
          {idx:24, name:"ËÉ°‰ΩõÊ∞¥Â£©", price:8000, group:"red"},
          {idx:26, name:"ÁôΩÂÆÆ", price:8600, group:"yellow"},
          {idx:27, name:"ÊûóËÇØÁ¥ÄÂøµÂ†Ç", price:8600, group:"yellow"},
          {idx:29, name:"ÂúãÊúÉÂ§ßÂªà", price:9300, group:"yellow"},
          {idx:31, name:"ÈÇÅÈòøÂØÜÊµ∑ÁÅò", price:10000, group:"green"},
          {idx:32, name:"Â•ßËò≠Â§ö", price:10000, group:"green"},
          {idx:34, name:"Â§™Á©∫‰∏≠ÂøÉ", price:10600, group:"green"},
          {idx:37, name:"ËäùÂä†Âì•", price:11600, group:"darkblue"},
          {idx:39, name:"Ë•øÈõÖÂúñ", price:13200, group:"darkblue"}
        ],
        stations: [
          {idx:5, name:"‰∏≠Â§ÆËªäÁ´ô"},
          {idx:15, name:"ËÅØÂêàËªäÁ´ô"},
          {idx:25, name:"Ë≥ìÂ∑ûËªäÁ´ô"},
          {idx:35, name:"ÂçóÁ´ô"}
        ],
        utilities: [
          {idx:12, name:"Ê∞¥ÂãôÂÖ¨Âè∏"},
          {idx:28, name:"ÈõªÂäõÂÖ¨Âè∏"}
        ]
      },
      hongkong: {
        name: "È¶ôÊ∏Ø",
        properties: [
          {idx:1, name:"Êó∫Ëßí", price:2000, group:"brown"},
          {idx:3, name:"Ê≤πÈ∫ªÂú∞", price:2000, group:"brown"},
          {idx:6, name:"Â§™Âπ≥Â±±", price:3300, group:"lightblue"},
          {idx:8, name:"Ê∑∫Ê∞¥ÁÅ£", price:3300, group:"lightblue"},
          {idx:9, name:"Ëµ§Êü±", price:4000, group:"lightblue"},
          {idx:11, name:"‰∏≠Áí∞", price:4600, group:"pink"},
          {idx:13, name:"ÈáëÈêò", price:4600, group:"pink"},
          {idx:14, name:"ÈäÖÈëºÁÅ£", price:5300, group:"pink"},
          {idx:16, name:"Â∞ñÊ≤ôÂíÄ", price:6000, group:"orange"},
          {idx:18, name:"Êµ∑Ê∏ØÂüé", price:6000, group:"orange"},
          {idx:19, name:"ÊòüÂÖâÂ§ßÈÅì", price:6600, group:"orange"},
          {idx:21, name:"Ëø™Â£´Â∞ºÊ®ÇÂúí", price:7300, group:"red"},
          {idx:23, name:"Êµ∑Ê¥ãÂÖ¨Âúí", price:7300, group:"red"},
          {idx:24, name:"ÊòÇÂù™360", price:8000, group:"red"},
          {idx:26, name:"Á∂≠Â§öÂà©‰∫ûÊ∏Ø", price:8600, group:"yellow"},
          {idx:27, name:"Â§©ÊòüÂ∞èËº™", price:8600, group:"yellow"},
          {idx:29, name:"Ëò≠Ê°ÇÂùä", price:9300, group:"yellow"},
          {idx:31, name:"Ë•øË≤¢", price:10000, group:"green"},
          {idx:32, name:"Â§ßÂ∂ºÂ±±", price:10000, group:"green"},
          {idx:34, name:"Âçó‰∏´Â≥∂", price:10600, group:"green"},
          {idx:37, name:"IFCÂúãÈöõÈáëËûç‰∏≠ÂøÉ", price:11600, group:"darkblue"},
          {idx:39, name:"ICCÁí∞ÁêÉË≤øÊòìÂª£Â†¥", price:13200, group:"darkblue"}
        ],
        stations: [
          {idx:5, name:"‰∏≠Áí∞Á´ô"},
          {idx:15, name:"ÈáëÈêòÁ´ô"},
          {idx:25, name:"Â∞ñÊ≤ôÂíÄÁ´ô"},
          {idx:35, name:"Êó∫ËßíÁ´ô"}
        ],
        utilities: [
          {idx:12, name:"‰∏≠ËèØÈõªÂäõ"},
          {idx:28, name:"Ê∏ØÁáà"}
        ]
      },
      vietnam: {
        name: "Ë∂äÂçó",
        properties: [
          {idx:1, name:"‰∏âÂçÅÂÖ≠Ë°åË°ó", price:2000, group:"brown"},
          {idx:3, name:"ÈÇÑÂäçÊπñ", price:2000, group:"brown"},
          {idx:6, name:"‰∏ãÈæçÁÅ£", price:3300, group:"lightblue"},
          {idx:8, name:"ÂØßÂπ≥", price:3300, group:"lightblue"},
          {idx:9, name:"Ê≤ôÂ£©", price:4000, group:"lightblue"},
          {idx:11, name:"ËÉ°ÂøóÊòéÂ∏Ç", price:4600, group:"pink"},
          {idx:13, name:"Êø±ÂüéÂ∏ÇÂ†¥", price:4600, group:"pink"},
          {idx:14, name:"Áµ±‰∏ÄÂÆÆ", price:5300, group:"pink"},
          {idx:16, name:"ÊúÉÂÆâÂè§ÈéÆ", price:6000, group:"orange"},
          {idx:18, name:"Â≥¥Ê∏Ø", price:6000, group:"orange"},
          {idx:19, name:"Â∑¥ÊãøÂ±±", price:6600, group:"orange"},
          {idx:21, name:"È†ÜÂåñÁöáÂüé", price:7300, group:"red"},
          {idx:23, name:"È¶ôÊ±ü", price:7300, group:"red"},
          {idx:24, name:"Â§©Âß•ÂØ∫", price:8000, group:"red"},
          {idx:26, name:"ËäΩËéäÊµ∑ÁÅò", price:8600, group:"yellow"},
          {idx:27, name:"ÁèçÁè†Â≥∂", price:8600, group:"yellow"},
          {idx:29, name:"Â©ÜÈÇ£Âä†Âç†Â©ÜÂ°î", price:9300, group:"yellow"},
          {idx:31, name:"ÁæéÂ•à", price:10000, group:"green"},
          {idx:32, name:"Â§ßÂèª", price:10000, group:"green"},
          {idx:34, name:"ÂØåÂúãÂ≥∂", price:10600, group:"green"},
          {idx:37, name:"ÊπÑÂÖ¨Ê≤≥", price:11600, group:"darkblue"},
          {idx:39, name:"ËäπËã¥Ê∞¥‰∏äÂ∏ÇÂ†¥", price:13200, group:"darkblue"}
        ],
        stations: [
          {idx:5, name:"Ê≤≥ÂÖßÁ´ô"},
          {idx:15, name:"Â≥¥Ê∏ØÁ´ô"},
          {idx:25, name:"ËÉ°ÂøóÊòéÁ´ô"},
          {idx:35, name:"ËäΩËéäÁ´ô"}
        ],
        utilities: [
          {idx:12, name:"Ë∂äÂçóÈõªÂäõ"},
          {idx:28, name:"Ë•øË≤¢Ê∞¥Âãô"}
        ]
      },
      korea: {
        name: "ÈüìÂúã",
        properties: [
          {idx:1, name:"ÊòéÊ¥û", price:2000, group:"brown"},
          {idx:3, name:"Êù±Â§ßÈñÄ", price:2000, group:"brown"},
          {idx:6, name:"ÂçóÂ±±Â°î", price:3300, group:"lightblue"},
          {idx:8, name:"ÂåóÊùëÈüìÂ±ãÊùë", price:3300, group:"lightblue"},
          {idx:9, name:"ÊôØÁ¶èÂÆÆ", price:4000, group:"lightblue"},
          {idx:11, name:"Ê±üÂçóÂçÄ", price:4600, group:"pink"},
          {idx:13, name:"ÊòéÊ¥ûËÅñÂ†Ç", price:4600, group:"pink"},
          {idx:14, name:"Ê±ùÁü£Â≥∂", price:5300, group:"pink"},
          {idx:16, name:"ÈáúÂ±±Êµ∑Ê∞¥Êµ¥Â†¥", price:6000, group:"orange"},
          {idx:18, name:"Êµ∑Èõ≤Âè∞", price:6000, group:"orange"},
          {idx:19, name:"Â§™ÂÆóÂè∞", price:6600, group:"orange"},
          {idx:21, name:"ÊÖàÁÖßÂØ∫", price:7300, group:"red"},
          {idx:23, name:"‰∏çÂúãÂØ∫", price:7300, group:"red"},
          {idx:24, name:"Áü≥Á™©Â∫´Âªü", price:8000, group:"red"},
          {idx:26, name:"ÊøüÂ∑ûÂ≥∂", price:8600, group:"yellow"},
          {idx:27, name:"ÂüéÂ±±Êó•Âá∫Â≥∞", price:8600, group:"yellow"},
          {idx:29, name:"Ëê¨‰∏àÁ™©", price:9300, group:"yellow"},
          {idx:31, name:"ÂçóÊÄ°Â≥∂", price:10000, group:"green"},
          {idx:32, name:"Êµ∑Èõ≤Âè∞", price:10000, group:"green"},
          {idx:34, name:"ÁôΩÈ†≠Â±±", price:10600, group:"green"},
          {idx:37, name:"Ê®ÇÂ§©‰∏ñÁïåÂ°î", price:11600, group:"darkblue"},
          {idx:39, name:"È¶ñÁàæÂ§©Á©∫ÂÖ¨Âúí", price:13200, group:"darkblue"}
        ],
        stations: [
          {idx:5, name:"È¶ñÁàæÁ´ô"},
          {idx:15, name:"ÈáúÂ±±Á´ô"},
          {idx:25, name:"ÊÖ∂Â∑ûÁ´ô"},
          {idx:35, name:"Â§ßÈÇ±Á´ô"}
        ],
        utilities: [
          {idx:12, name:"ÈüìÂúãÈõªÂäõÂÖ¨Á§æ"},
          {idx:28, name:"È¶ñÁàæÊ∞¥ÈÅì"}
        ]
      },
      italy: {
        name: "Áæ©Â§ßÂà©",
        properties: [
          {idx:1, name:"ÁæÖÈ¶¨Á´∂ÊäÄÂ†¥", price:2000, group:"brown"},
          {idx:3, name:"Ë´æÁ∂≠Âô¥Ê≥â", price:2000, group:"brown"},
          {idx:6, name:"ÊØîËñ©ÊñúÂ°î", price:3300, group:"lightblue"},
          {idx:8, name:"‰ΩõÁæÖÂÄ´ÊñØÂ§ßÊïôÂ†Ç", price:3300, group:"lightblue"},
          {idx:9, name:"ÁÉèËè≤Ëå≤ÁæéË°ìÈ§®", price:4000, group:"lightblue"},
          {idx:11, name:"Â®ÅÂ∞ºÊñØÂ§ßÈÅãÊ≤≥", price:4600, group:"pink"},
          {idx:13, name:"ËÅñÈ¶¨ÂèØÂª£Â†¥", price:4600, group:"pink"},
          {idx:14, name:"Èõ∑ÈõÖÊâòÊ©ã", price:5300, group:"pink"},
          {idx:16, name:"Á±≥Ëò≠Â§ßÊïôÂ†Ç", price:6000, group:"orange"},
          {idx:18, name:"ÊúÄÂæåÁöÑÊôöÈ§ê", price:6000, group:"orange"},
          {idx:19, name:"ÂüÉÈ¶¨Á¥êÂüÉ‰∫å‰∏ñÈï∑Âªä", price:6600, group:"orange"},
          {idx:21, name:"ÈæêÂüπÂè§Âüé", price:7300, group:"red"},
          {idx:23, name:"ÈòøÁë™ÁàæËè≤Êµ∑Â≤∏", price:7300, group:"red"},
          {idx:24, name:"ËÅñÂêâÁ±≥Â∞º‰∫ûË´æÂª£Â†¥", price:8000, group:"red"},
          {idx:26, name:"Ê¢µËíÇÂ≤°ÂçöÁâ©È§®", price:8600, group:"yellow"},
          {idx:27, name:"Ë•øÊñØÂª∑ÊïôÂ†Ç", price:8600, group:"yellow"},
          {idx:29, name:"ËÅñÂΩºÂæóÂ§ßÊïôÂ†Ç", price:9300, group:"yellow"},
          {idx:31, name:"‰∫îÊ∏îÊùë", price:10000, group:"green"},
          {idx:32, name:"Â§öÊ¥õÁ±≥ËíÇÂ±±", price:10000, group:"green"},
          {idx:34, name:"Âç°Â∏ÉÈáåÂ≥∂", price:10600, group:"green"},
          {idx:37, name:"Á±≥Ëò≠ÊñØÂç°ÊãâÂ§ßÂäáÈô¢", price:11600, group:"darkblue"},
          {idx:39, name:"Âú£ÊØçÁôæËä±Â§ßÊïôÂ†Ç", price:13200, group:"darkblue"}
        ],
        stations: [
          {idx:5, name:"ÁæÖÈ¶¨‰∏≠Â§ÆÁ´ô"},
          {idx:15, name:"‰ΩõÁæÖÂÄ´ÊñØÁ´ô"},
          {idx:25, name:"Á±≥Ëò≠Á´ô"},
          {idx:35, name:"Â®ÅÂ∞ºÊñØÁ´ô"}
        ],
        utilities: [
          {idx:12, name:"Áæ©Â§ßÂà©ÈõªÂäõ"},
          {idx:28, name:"ÁæÖÈ¶¨Ê∞¥ÈÅì"}
        ]
      },
      netherlands: {
        name: "Ëç∑Ëò≠",
        properties: [
          {idx:1, name:"Ê∞¥Â£©Âª£Â†¥", price:2000, group:"brown"},
          {idx:3, name:"Á¥ÖÁáàÂçÄ", price:2000, group:"brown"},
          {idx:6, name:"Ê°ëÊñØÈ¢®ËªäÊùë", price:3300, group:"lightblue"},
          {idx:8, name:"Â∫´ÂãíÁ©ÜÂãíÈ¢®Ëªä", price:3300, group:"lightblue"},
          {idx:9, name:"È¶¨ËÇØÊ©ã", price:4000, group:"lightblue"},
          {idx:11, name:"Ê¢µÈ´òÂçöÁâ©È§®", price:4600, group:"pink"},
          {idx:13, name:"ÂúãÁ´ãÂçöÁâ©È§®", price:4600, group:"pink"},
          {idx:14, name:"ÂÆâÂ¶Æ‰πãÂÆ∂", price:5300, group:"pink"},
          {idx:16, name:"ÈπøÁâπ‰∏πÊ∏Ø", price:6000, group:"orange"},
          {idx:18, name:"Â∞èÂ≠©Â†§Èò≤", price:6000, group:"orange"},
          {idx:19, name:"Ê≠êÊ¥≤Ê∏Ø", price:6600, group:"orange"},
          {idx:21, name:"Â∫´ÂãíÁ©ÜÂãíËä±Âúí", price:7300, group:"red"},
          {idx:23, name:"ÈòøÂßÜÊñØÁâπ‰∏πÈÅãÊ≤≥", price:7300, group:"red"},
          {idx:24, name:"ÁæäËßíÊùë", price:8000, group:"red"},
          {idx:26, name:"Êµ∑ÁâôÂúãÈöõÊ≥ïÂ∫≠", price:8600, group:"yellow"},
          {idx:27, name:"Âπ≥ÂíåÂÆÆ", price:8600, group:"yellow"},
          {idx:29, name:"È¶¨Âæ∑ÁæÖ‰∏πÂ§ßÂ£©", price:9300, group:"yellow"},
          {idx:31, name:"ÈòøÂßÜÊñØÁâπ‰∏πÊ∞¥Â£©", price:10000, group:"green"},
          {idx:32, name:"ÂåóÊµ∑ÊºÅÊùë", price:10000, group:"green"},
          {idx:34, name:"‰∏âËßíÊ¥≤", price:10600, group:"green"},
          {idx:37, name:"ÈòøÂßÜÊñØÁâπ‰∏πÁ´∂ÊäÄÂ†¥", price:11600, group:"darkblue"},
          {idx:39, name:"ÈòøÂßÜÊñØÁâπ‰∏π‰∏≠Â§ÆËªäÁ´ô", price:13200, group:"darkblue"}
        ],
        stations: [
          {idx:5, name:"ÈòøÂßÜÊñØÁâπ‰∏πÁ´ô"},
          {idx:15, name:"ÈπøÁâπ‰∏πÁ´ô"},
          {idx:25, name:"Êµ∑ÁâôÁ´ô"},
          {idx:35, name:"ÁÉèÂæóÂãíÊîØÁ´ô"}
        ],
        utilities: [
          {idx:12, name:"Ëç∑Ëò≠ÈõªÂäõ"},
          {idx:28, name:"ÈòøÂßÜÊñØÁâπ‰∏πÊ∞¥Âãô"}
        ]
      },
      russia: {
        name: "‰øÑÁæÖÊñØ",
        properties: [
          {idx:1, name:"Á¥ÖÂ†¥", price:2000, group:"brown"},
          {idx:3, name:"ÂÖãÈáåÂßÜÊûóÂÆÆ", price:2000, group:"brown"},
          {idx:6, name:"ËÅñÁì¶Ë•øÈáåÂ§ßÊïôÂ†Ç", price:3300, group:"lightblue"},
          {idx:8, name:"ÂÜ¨ÂÆÆ", price:3300, group:"lightblue"},
          {idx:9, name:"Â§èÂÆÆ", price:4000, group:"lightblue"},
          {idx:11, name:"ËÅñÂΩºÂæóÂ†°Ë¶ÅÂ°û", price:4600, group:"pink"},
          {idx:13, name:"ÊªîÁì¶Ê≤≥", price:4600, group:"pink"},
          {idx:14, name:"ÊªîÁì¶Ê≤≥ÈÅäËàπ", price:5300, group:"pink"},
          {idx:16, name:"Ë≤ùÂä†ÁàæÊπñ", price:6000, group:"orange"},
          {idx:18, name:"Ë•ø‰ºØÂà©‰∫ûÈêµË∑Ø", price:6000, group:"orange"},
          {idx:19, name:"‰ºäÁàæÂ∫´Ëå®ÂÖã", price:6600, group:"orange"},
          {idx:21, name:"ÈáëÁí∞", price:7300, group:"red"},
          {idx:23, name:"ËòáËå≤ÈÅîÁàæ", price:7300, group:"red"},
          {idx:24, name:"ÂñáÂòâÂ±±", price:8000, group:"red"},
          {idx:26, name:"Á¥¢Â•ëÂÜ¨ÂÆÆÊúÉ", price:8600, group:"yellow"},
          {idx:27, name:"ÈªëÊµ∑Â∫¶ÂÅáÊùë", price:8600, group:"yellow"},
          {idx:29, name:"È´òÂä†Á¥¢Â±±ËÑà", price:9300, group:"yellow"},
          {idx:31, name:"Â†°Â£òÂ≥∂", price:10000, group:"green"},
          {idx:32, name:"ÂãòÂØüÂä†ÂçäÂ≥∂", price:10000, group:"green"},
          {idx:34, name:"Êë©ÁàæÊõºÊñØÂÖã", price:10600, group:"green"},
          {idx:37, name:"Ëé´ÊñØÁßëÂ§ßÂ≠∏", price:11600, group:"darkblue"},
          {idx:39, name:"Ëé´ÊñØÁßëÂú∞Èêµ", price:13200, group:"darkblue"}
        ],
        stations: [
          {idx:5, name:"Ëé´ÊñØÁßëÁ´ô"},
          {idx:15, name:"ËÅñÂΩºÂæóÂ†°Á´ô"},
          {idx:25, name:"ËëâÂç°Êç∑Áê≥Â†°Á´ô"},
          {idx:35, name:"Á¥¢Â•ëÁ´ô"}
        ],
        utilities: [
          {idx:12, name:"‰øÑÁæÖÊñØÈõªÂäõ"},
          {idx:28, name:"Ëé´ÊñØÁßëÊ∞¥Âãô"}
        ]
      },
      galaxy: {
        name: "ÈäÄÊ≤≥Á≥ª",
        properties: [
          {idx:1, name:"ÊúàÁêÉÂü∫Âú∞", price:2000, group:"brown"},
          {idx:3, name:"ÁÅ´ÊòüÂü∫Âú∞", price:2000, group:"brown"},
          {idx:6, name:"Êú®ÊòüË°õÊòü", price:3300, group:"lightblue"},
          {idx:8, name:"ÂúüÊòüÁí∞", price:3300, group:"lightblue"},
          {idx:9, name:"Â§©ÁéãÊòü", price:4000, group:"lightblue"},
          {idx:11, name:"Êµ∑ÁéãÊòü", price:4600, group:"pink"},
          {idx:13, name:"ÂÜ•ÁéãÊòü", price:4600, group:"pink"},
          {idx:14, name:"ÊüØ‰ºä‰ºØÂ∏∂", price:5300, group:"pink"},
          {idx:16, name:"‰ªôÂ•≥Â∫ßÊòüÈõ≤", price:6000, group:"orange"},
          {idx:18, name:"ÁçµÊà∂Â∫ßÊòüÈõ≤", price:6000, group:"orange"},
          {idx:19, name:"Â§©Èπ∞ÊòüÈõ≤", price:6600, group:"orange"},
          {idx:21, name:"Áå©Êà∂Â∫ßÊòüÁ≥ª", price:7300, group:"red"},
          {idx:23, name:"‰ªôÂ•≥Â∫ßÊòüÁ≥ª", price:7300, group:"red"},
          {idx:24, name:"‰∏âËßíÂ∫ßÊòüÁ≥ª", price:8000, group:"red"},
          {idx:26, name:"Áå©Â§´Â∫ßÊòüÈõ≤", price:8600, group:"yellow"},
          {idx:27, name:"È¶¨È†≠ÊòüÈõ≤", price:8600, group:"yellow"},
          {idx:29, name:"È∑πÁãÄÊòüÈõ≤", price:9300, group:"yellow"},
          {idx:31, name:"Áå©Êà∂Â∫ß‰∏≠ÂøÉ", price:10000, group:"green"},
          {idx:32, name:"ÈªëÊ¥ûÂçÄÂüü", price:10000, group:"green"},
          {idx:34, name:"ËÑÜÊòüÈõ≤", price:10600, group:"green"},
          {idx:37, name:"‰ªôÂ•≥Â∫ßA", price:11600, group:"darkblue"},
          {idx:39, name:"ÈäÄÊ≤≥‰∏≠ÂøÉ", price:13200, group:"darkblue"}
        ],
        stations: [
          {idx:5, name:"Âú∞ÁêÉËª∏ÂøÉÁ´ô"},
          {idx:15, name:"ÁÅ´Êòü‰∏≠ÁπºÁ´ô"},
          {idx:25, name:"Êú®ÊòüËª∏ÂøÉÁ´ô"},
          {idx:35, name:"ÂúüÊòü‰∏≠ÁπºÁ´ô"}
        ],
        utilities: [
          {idx:12, name:"Â§™ÈôΩËÉΩÈõªÁ∂≤"},
          {idx:28, name:"Ê∞ÆÊ∞£Êé°ÈõÜÁ´ô"}
        ]
      }
    };
    
    
    // ========== AI ÂÄãÊÄßÁ≥ªÁµ± ==========
    var AI_PERSONALITIES = {
      aggressive: {
        name: "ÊøÄÈÄ≤Âûã",
        buyThreshold: 0.3,        // ÁèæÈáëÊØî‰æãÈñæÂÄºÔºà‰Ωé=Êõ¥ÊøÄÈÄ≤Ôºâ
        buildThreshold: 0.2,      // Âª∫ÊàøÁèæÈáëÊØî‰æãÈñæÂÄº
        jailPayProbability: 0.8,  // ‰ªòË≤ªÂá∫ÁçÑÊ¶ÇÁéá
        monopolyBonus: 1.5,       // Â£üÊñ∑Âú∞Áî¢ÂÉπÂÄºÂä†Êàê
        riskTolerance: 0.8        // È¢®Èö™ÂÆπÂøçÂ∫¶
      },
      conservative: {
        name: "‰øùÂÆàÂûã",
        buyThreshold: 0.5,
        buildThreshold: 0.4,
        jailPayProbability: 0.3,
        monopolyBonus: 1.2,
        riskTolerance: 0.3
      },
      balanced: {
        name: "Âπ≥Ë°°Âûã",
        buyThreshold: 0.4,
        buildThreshold: 0.3,
        jailPayProbability: 0.5,
        monopolyBonus: 1.3,
        riskTolerance: 0.5
      },
      speculative: {
        name: "ÊäïÊ©üÂûã",
        buyThreshold: 0.25,
        buildThreshold: 0.15,
        jailPayProbability: 0.9,
        monopolyBonus: 1.8,
        riskTolerance: 0.9
      }
    };
    
    
    // ========== AI Êô∫ËÉΩË©ï‰º∞Á≥ªÁµ± ==========
    
    // Ë©ï‰º∞Âú∞Áî¢ÂÉπÂÄº
    function evaluatePropertyValue(player, tileIdx) {
      var tile = tiles[tileIdx];
      if (tile.type !== 'PROPERTY') return 0;
      
      var personality = player.aiPersonalityData || AI_PERSONALITIES.balanced;
      var score = 0;
      
      // Âü∫Á§éÂÉπÂÄº
      score += tile.price / 1000;
      
      // Ê™¢Êü•ÊòØÂê¶ËÉΩÂΩ¢ÊàêÂ£üÊñ∑
      var group = tile.group;
      var groupTiles = tiles.filter(function(t) { 
        return t.type === 'PROPERTY' && t.group === group; 
      });
      var ownedInGroup = groupTiles.filter(function(t) {
        return player.properties.indexOf(t.idx) >= 0;
      }).length;
      var totalInGroup = groupTiles.length;
      
      // Â£üÊñ∑ÊΩõÂäõÂä†Êàê
      if (ownedInGroup === totalInGroup - 1) {
        // Âè™Â∑Æ‰∏ÄÂÄãÂ∞±ËÉΩÂ£üÊñ∑
        score += 50 * personality.monopolyBonus;
      } else if (ownedInGroup > 0) {
        // Â∑≤Á∂ìÊìÅÊúâÂêåËâ≤ÁµÑÁöÑÂÖ∂‰ªñÂú∞Áî¢
        score += 20 * (ownedInGroup / totalInGroup);
      }
      
      // Ê™¢Êü•ÂÖ∂‰ªñÁé©ÂÆ∂ÊòØÂê¶ÊìÅÊúâÂêåËâ≤ÁµÑ
      var othersOwnInGroup = state.players.filter(function(p) {
        return p.id !== player.id && p.alive;
      }).some(function(p) {
        return groupTiles.some(function(t) {
          return p.properties.indexOf(t.idx) >= 0;
        });
      });
      
      if (othersOwnInGroup) {
        // ÈòªÊ≠¢Â∞çÊâãÂ£üÊñ∑
        score += 15;
      }
      
      // ‰ΩçÁΩÆÂÉπÂÄºÔºàÂæåÈù¢ÁöÑÂú∞Áî¢ÈÄöÂ∏∏Êõ¥Ë≤¥Êõ¥ÊúâÂÉπÂÄºÔºâ
      score += tileIdx / 4;
      
      return score;
    }
    
    // Ë©ï‰º∞ÊòØÂê¶ÊáâË©≤Ë≥ºË≤∑
    function shouldAIBuyProperty(player, tileIdx, price) {
      var personality = player.aiPersonalityData || AI_PERSONALITIES.balanced;
      
      // Ê™¢Êü•ÁèæÈáëÊòØÂê¶ÂÖÖË∂≥
      var cashRatio = player.cash / 100000; // Áõ∏Â∞çÊñºÂàùÂßãË≥áÈáëÁöÑÊØî‰æã
      if (cashRatio < personality.buyThreshold) {
        // ÁèæÈáë‰∏çË∂≥Ôºå‰ΩÜÂ¶ÇÊûúÊòØÂ£üÊñ∑Ê©üÊúÉÂâáËÄÉÊÖÆË≥ºË≤∑
        var tile = tiles[tileIdx];
        if (tile.type === 'PROPERTY') {
          var group = tile.group;
          var groupTiles = tiles.filter(function(t) { 
            return t.type === 'PROPERTY' && t.group === group; 
          });
          var ownedInGroup = groupTiles.filter(function(t) {
            return player.properties.indexOf(t.idx) >= 0;
          }).length;
          
          if (ownedInGroup === groupTiles.length - 1) {
            // Â£üÊñ∑Ê©üÊúÉÔºåÂç≥‰ΩøÁèæÈáëÁ∑äÂºµ‰πüË≥ºË≤∑
            return player.cash >= price * 1.2;
          }
        }
        return false;
      }
      
      // Ë©ï‰º∞Âú∞Áî¢ÂÉπÂÄº
      var value = evaluatePropertyValue(player, tileIdx);
      
      // Ê†πÊìöÂÉπÂÄºÂíåÂÄãÊÄßÊ±∫ÂÆö
      var threshold = 10 + (1 - personality.riskTolerance) * 20;
      return value > threshold;
    }
    
    // Ë©ï‰º∞ÊòØÂê¶ÊáâË©≤ÂçáÁ¥öÊàøÂ±ã
    function shouldAIBuildHouse(player, tileIdx) {
      var personality = player.aiPersonalityData || AI_PERSONALITIES.balanced;
      var tile = tiles[tileIdx];
      
      if (tile.type !== 'PROPERTY') return false;
      
      // Ê™¢Êü•ÊòØÂê¶ÊìÅÊúâÂ£üÊñ∑
      var group = tile.group;
      var groupTiles = tiles.filter(function(t) { 
        return t.type === 'PROPERTY' && t.group === group; 
      });
      var allOwned = groupTiles.every(function(t) {
        return player.properties.indexOf(t.idx) >= 0;
      });
      
      if (!allOwned) return false;
      
      // Ê™¢Êü•ÁèæÈáë
      var buildCost = HOUSE_COST[group] || 3300;
      var currentLevel = state.houses[tileIdx] || 0;
      if (currentLevel >= 5) return false;
      
      var cashAfterBuild = player.cash - buildCost;
      var cashRatio = cashAfterBuild / 100000;
      
      if (cashRatio < personality.buildThreshold) return false;
      
      // Ë©ï‰º∞ÂõûÂ†±Áéá
      var currentRent = getRent(tileIdx);
      var nextRent = getRent(tileIdx, currentLevel + 1);
      var rentIncrease = nextRent - currentRent;
      var roi = rentIncrease / buildCost;
      
      // ROI È´òÊñºÈñæÂÄºÊâçÂª∫Êàø
      return roi > (0.1 / personality.riskTolerance);
    }
    
    // Áç≤ÂèñÁßüÈáëÔºàÁî®ÊñºË©ï‰º∞Ôºâ
    function getRent(tileIdx, level) {
      var tile = tiles[tileIdx];
      if (tile.type !== 'PROPERTY') return 0;
      
      var lv = level !== undefined ? level : (state.houses[tileIdx] || 0);
      var baseRent = Math.floor(tile.price * 0.1);
      var rentTable = [baseRent, baseRent*5, baseRent*15, baseRent*45, baseRent*80, baseRent*110];
      return rentTable[lv] || 0;
    }
    
    // Ë©ï‰º∞ÊòØÂê¶ÊáâË©≤‰ªòË≤ªÂá∫ÁçÑ
    function shouldAIPayJail(player) {
      var personality = player.aiPersonalityData || AI_PERSONALITIES.balanced;
      
      // Ê™¢Êü•ÁèæÈáë
      if (player.cash < JAIL_FEE * 2) return false;
      
      // Ê™¢Êü•ÈÅäÊà≤ÈöéÊÆµ
      var totalProperties = tiles.filter(function(t) { 
        return t.type === 'PROPERTY'; 
      }).length;
      var ownedProperties = player.properties.length;
      var gameProgress = ownedProperties / totalProperties;
      
      // ÈÅäÊà≤ÂæåÊúüÊõ¥ÂÇæÂêëÊñº‰ªòË≤ªÂá∫ÁçÑ
      var payProbability = personality.jailPayProbability * (0.5 + gameProgress);
      
      return Math.random() < payProbability;
    }

    // ÁÇ∫ÊØèÂÄã AI ÂàÜÈÖçÂÄãÊÄß
    function assignAIPersonality(player) {
      var personalities = ['aggressive', 'conservative', 'balanced', 'speculative'];
      var randomPersonality = personalities[Math.floor(Math.random() * personalities.length)];
      player.aiPersonality = randomPersonality;
      player.aiPersonalityData = AI_PERSONALITIES[randomPersonality];
    }

    var currentMap = 'taiwan'; // È†êË®≠Âú∞Âúñ

    // ========== Èü≥ÊïàÁ≥ªÁµ± ==========
    let audioCtx = null;
    
    function initAudio() {
      if (!audioCtx) {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();
      }
      return audioCtx;
    }
    
    function playSound(type) {
      try {
        const ctx = initAudio();
        const oscillator = ctx.createOscillator();
        const gainNode = ctx.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(ctx.destination);
        
        const config = {
          roll: {freq: 440, dur: 0.1, vol: 0.3},
          move: {freq: 523, dur: 0.05, vol: 0.1},
          buy: {freq: 659, dur: 0.2, vol: 0.3},
          build: {freq: 784, dur: 0.3, vol: 0.3},
          error: {freq: 200, dur: 0.15, vol: 0.3},
          click: {freq: 800, dur: 0.05, vol: 0.15}
        }[type] || {freq: 440, dur: 0.1, vol: 0.2};
        
        oscillator.frequency.value = config.freq;
        gainNode.gain.setValueAtTime(config.vol, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + config.dur);
        
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + config.dur);
      } catch(e) {
        console.log('Èü≥ÊïàÈåØË™§:', e);
      }
    }
    
    // ÁÇ∫ÊâÄÊúâÊåâÈàïÊ∑ªÂä†ÈªûÊìäÈü≥Êïà
    function addButtonSounds() {
      document.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
          try { playSound('click'); } catch(e) {}
        });
      });
    }
    // ========== Èü≥ÊïàÁ≥ªÁµ±ÁµêÊùü ==========
    var $ = function(s){ return document.querySelector(s); };
    var $$ = function(s){ return Array.prototype.slice.call(document.querySelectorAll(s)); };
    function sleep(ms){ return new Promise(function(r){ setTimeout(r,ms); }); }
    function shuffle(a){ for(var i=a.length-1;i>0;i--){ var j=Math.floor(Math.random()*(i+1)); var t=a[i]; a[i]=a[j]; a[j]=t; } return a; }
    function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

    // ----- Á∂ìÊøüÂèÉÊï∏ÔºàÊèêÈ´òÊï¥È´îÈáëÈ°çÔºâ -----
    var START_SALARY = 6600;   // Ëµ∑ÈªûËñ™Ë≥á ($200 * 33)
    var JAIL_FINE = 1650;      // ‰øùÈáãÈáë ($50 * 33)
    var STATION_RENTS = [825,1650,3300,6600]; // ËªäÁ´ôÁßüÈáëÂçáÁ¥ö ([25,50,100,200] * 33)
    var BASE_RENT_FACTOR = 0.18; // Âú∞Áî¢Âü∫Á§éÁßüÈáëÂæû 12% -> 18%

    var COLORS = {brown:"#8d5524",lightBlue:"#7ab6ff",pink:"#ff8dc7",orange:"#ffa14a",red:"#ff6b6b",yellow:"#ffd93d",green:"#28c76f",darkBlue:"#5470ff"};
    var HOUSE_COST = { // Âª∫Â±ãÊàêÊú¨ÔºàÊØèÊ£üÔºâÔºåÊåâÈ°èËâ≤Áæ§
      brown:100, lightBlue:100, pink:150, orange:150, red:200, yellow:200, green:250, darkBlue:300
    };
    var HOUSE_MULT = [1,3,5,7,9,12]; // 0~4 Ê£üËàá 5ÔºàÊóÖÈ§®ÔºâÁöÑÁßüÈáëÂÄçÁéáÔºàÁõ∏Â∞ç baseRentÔºâ

    // ----- Âú∞Âúñ -----
    
    // ÂãïÊÖãÁîüÊàê tiles Êï∏ÁµÑ
    function generateTiles(mapKey) {
      var mapData = MAPS[mapKey];
      var tiles = new Array(40);
      
      // ÂàùÂßãÂåñÊâÄÊúâÊ†ºÂ≠êÁÇ∫Á©∫
      for (var i = 0; i < 40; i++) {
        tiles[i] = {idx: i, type: "EMPTY", name: "", price: 0, group: ""};
      }
      
      // ÁâπÊÆäÊ†ºÂ≠ê
      tiles[0] = {idx:0, type:"GO", label:"Ëµ∑Èªû"};
      tiles[10] = {idx:10, type:"JAIL", label:"Áõ£ÁçÑÔºèÊé¢Áõ£"};
      tiles[20] = {idx:20, type:"FREE", label:"ÂÖçË≤ªÂÅúËªä"};
      tiles[30] = {idx:30, type:"GOTOJAIL", label:"ÂÖ•ÁçÑ"};
      
      // Ê©üÊúÉÂíåÂëΩÈÅã
      tiles[7] = {idx:7, type:"CHANCE", label:"Ê©üÊúÉ"};
      tiles[22] = {idx:22, type:"CHANCE", label:"Ê©üÊúÉ"};
      tiles[36] = {idx:36, type:"CHANCE", label:"Ê©üÊúÉ"};
      tiles[2] = {idx:2, type:"CHEST", label:"ÂëΩÈÅã"};
      tiles[17] = {idx:17, type:"CHEST", label:"ÂëΩÈÅã"};
      tiles[33] = {idx:33, type:"CHEST", label:"ÂëΩÈÅã"};
      
      // Á®ÖÈáë
      tiles[4] = {idx:4, type:"TAX", amount:10000, label:"ÊâÄÂæóÁ®Ö"};
      tiles[38] = {idx:38, type:"TAX", amount:5000, label:"Ë±™ËèØÁ®Ö"};
      
      // Âú∞Áî¢
      mapData.properties.forEach(function(prop) {
        tiles[prop.idx] = {
          idx: prop.idx,
          type: "PROPERTY",
          name: prop.name,
          price: prop.price,
          group: prop.group
        };
      });
      
      // ËªäÁ´ô
      mapData.stations.forEach(function(station) {
        tiles[station.idx] = {
          idx: station.idx,
          type: "STATION",
          name: station.name
        };
      });
      
      // ÂÖ¨Áî®‰∫ãÊ•≠
      mapData.utilities.forEach(function(util) {
        tiles[util.idx] = {
          idx: util.idx,
          type: "UTILITY",
          name: util.name
        };
      });
      
      return tiles;
    }
    
    var tiles = generateTiles(currentMap);


    function baseRent(price){ return Math.round(price*BASE_RENT_FACTOR); }
    function getPrice(t){ if (t.type==="PROPERTY") return t.price; if (t.type==="STATION") return 6600; if (t.type==="UTILITY") return 5000; return 0; }
    function idxToCoord(i){ if (i<=10) return {r:10,c:i}; if (i<=20) return {r:10-(i-10),c:10}; if (i<=30) return {r:0,c:10-(i-20)}; return {r:i-30,c:0}; }

    // ----- ÁãÄÊÖã -----
    var state = {
      players: [], cur:0, dice:[0,0], doublesInRow:0,
      awaitingBuy:false, mustEnd:false, bonusNextGo:[], logSeq:0,
      houses:{}, justBought:[], // { [idx]: 0..5 }
      hasUpgradedThisTurn: false, // 1ÂõûÂêàÂè™ËÉΩÂçáÁ¥ö‰∏ÄÊ¨°
      cardCollection: { chance: {}, chest: {} } // Âç°ÁâåÊî∂ËóèÁ≥ªÁµ±
    };
    var PlayerColors = ["#e74c3c","#2980b9","#27ae60","#8e44ad"];

    function uuid(){ try{ if (window.crypto && typeof window.crypto.randomUUID==='function') return window.crypto.randomUUID(); }catch(e){} return 'p-'+Math.random().toString(36).slice(2); }
    function makePlayer(name,isAI,color){ return { id: uuid(), name:name, isAI:isAI, color:color, cash:100000, pos:0, inJail:false, jailTurns:0, outCard:0, properties:[], mortgaged:[], alive:true, rentBonusTemp:0 }; }
    function initPlayers(){
      state.players=[
        makePlayer("‰Ω†",false,PlayerColors[0]),
        makePlayer("ËíºÂ∂∫",true,PlayerColors[1]),
        makePlayer("ÊòüÊ≤≥",true,PlayerColors[2]),
        makePlayer("Èõ≤Â≥´",true,PlayerColors[3])
      ];
      state.cur=0; state.dice=[0,0]; state.doublesInRow=0; state.awaitingBuy=false; state.mustEnd=false; state.bonusNextGo=[]; state.houses={}; state.justBought=[]; state.hasUpgradedThisTurn=false; state.cardCollection={ chance: {}, chest: {} };
      renderPlayers(); log("üéÆ v2.3 ÈñãÂßãÔºöËµ∑ÂßãË≥áÈáë $100,000ÔºåÊàøÂ±ãÁ≥ªÁµ±ÂïüÁî®„ÄÇ", false);
    }
    
    // ‰ΩøÁî®ÈÅ∏ÊìáÁöÑËßíËâ≤Âíå‰∫∫Êï∏ÂàùÂßãÂåñÁé©ÂÆ∂
    function initPlayersWithSelection() {
      // ÂæûËßíËâ≤Ê∏ÖÂñÆ‰∏≠ÁßªÈô§Â∑≤ÈÅ∏ÊìáÁöÑËßíËâ≤
      var availableChars = CHARACTERS.filter(function(c) { return c.id !== selectedCharacter.id; });
      
      // Èö®Ê©üÊâì‰∫Ç‰∏¶ÈÅ∏Êìá AI ËßíËâ≤
      shuffle(availableChars);
      var aiChars = availableChars.slice(0, selectedPlayerCount - 1);
      
      // ÂâµÂª∫Áé©ÂÆ∂ÂàóË°®
      state.players = [];
      
      // Áé©ÂÆ∂1Ôºö‰ΩøÁî®ËÄÖÈÅ∏ÊìáÁöÑËßíËâ≤
      state.players.push(makePlayer(selectedCharacter.name, false, PlayerColors[0]));
      
      // AI Áé©ÂÆ∂
      for (var i = 0; i < aiChars.length; i++) {
        state.players.push(makePlayer(aiChars[i].name, true, PlayerColors[i + 1]));
      }
      
      state.cur=0; state.dice=[0,0]; state.doublesInRow=0; state.awaitingBuy=false; state.mustEnd=false; state.bonusNextGo=[]; state.houses={}; state.justBought=[]; state.hasUpgradedThisTurn=false; state.cardCollection={ chance: {}, chest: {} };
      renderPlayers(); 
      log("üéÆ ÈÅäÊà≤ÈñãÂßãÔºÅ" + selectedPlayerCount + "‰∫∫Â∞çÊà∞ÔºåËµ∑ÂßãË≥áÈáë $100,000„ÄÇ", false);
    }

    // ----- Ê£ãÁõ§ËàáÊ£ãÂ≠ê -----
    function buildBoard(){
      var board=document.getElementById('board'); board.innerHTML='<div id="toast" class="toast hidden"></div>';
      for (var r=0;r<11;r++){ for (var c=0;c<11;c++){ var cell=document.createElement('div'); cell.className='tile empty'; cell.style.gridRow=(r+1); cell.style.gridColumn=(c+1); board.appendChild(cell); } }
      for (var k=0;k<tiles.length;k++){
        var t=tiles[k]; var pos=idxToCoord(t.idx); var cell=document.createElement('div'); cell.className='tile'; cell.style.gridRow=(pos.r+1); cell.style.gridColumn=(pos.c+1); cell.setAttribute('data-tile-idx', t.idx);
        var cls=""; if (t.type==="PROPERTY") cls="property"; if (t.type==="STATION") cls="station"; if (t.type==="UTILITY") cls="utility"; if (t.type==="TAX") cls="tax"; if (t.type==="CHANCE") cls="chance"; if (t.type==="CHEST") cls="chest"; if (t.type==="GOTOJAIL") cls="gotojail"; if (t.type==="JAIL") cls="jail"; if (t.type==="START") cls="start"; if (t.type==="FREE") cls="free"; if ([0,10,20,30].indexOf(t.idx)>=0) cell.classList.add('corner'); if (cls) cell.classList.add(cls);
        var label=document.createElement('div'); label.className='label'; label.textContent=t.name||t.label||""; cell.appendChild(label);
        if (t.type==="PROPERTY"){ var colorbar=document.createElement('div'); colorbar.className='colorbar'; colorbar.style.background=COLORS[t.group]||"#ccc"; cell.prepend(colorbar); var price=document.createElement('div'); price.className='price'; var p=t.price; var r0=baseRent(p); price.textContent="$"+p+"ÔΩúÁßü$"+r0; cell.appendChild(price); }
        if (t.type==="STATION"||t.type==="UTILITY"){ var price2=document.createElement('div'); price2.className='price'; price2.textContent="ÂèØË≥ºË≤∑"; cell.appendChild(price2); }
        var owner=document.createElement('div'); owner.className='owner'; owner.style.display='none'; owner.setAttribute('data-idx', t.idx); cell.appendChild(owner);
        // ÊàøÂ±ãÈ°ØÁ§∫
        var hs=document.createElement('div'); hs.className='house-stack'; hs.setAttribute('data-hidx', t.idx); cell.appendChild(hs);
        board.appendChild(cell);
      }
      renderTokens(); updateOwners(); renderHouses();
    }
    function renderTokens(){
      $$('.token').forEach(function(e){ e.remove(); });
      
      // ÊåâÊ†ºÂ≠êÂàÜÁµÑÊ£ãÂ≠ê
      var tokensByCell = {};
      for (var i=0;i<state.players.length;i++){
        var p=state.players[i]; 
        if (!p.alive) continue; 
        var key = p.pos;
        if (!tokensByCell[key]) tokensByCell[key] = [];
        tokensByCell[key].push({idx: i, player: p});
      }
      
      // Ê∏≤ÊüìÊØèÂÄãÊ†ºÂ≠êÁöÑÊ£ãÂ≠ê
      Object.keys(tokensByCell).forEach(function(posKey){
        var tokens = tokensByCell[posKey];
        var pos = idxToCoord(Number(posKey));
        var cell = document.querySelector('#board > .tile[style*="grid-area: '+(pos.r+1)+' / '+(pos.c+1)+'"]');
        if (!cell) return;
        
        // ÂâµÂª∫Ê£ãÂ≠êÂÆπÂô®
        var container = document.createElement('div');
        container.className = 'token-container';
        container.style.cssText = 'position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; gap: 2px; flex-wrap: wrap; padding: 2px; z-index: 250 !important;';
        
        tokens.forEach(function(t){
          var tok = document.createElement('div'); 
          tok.className = 'token'; 
          tok.style.background = t.player.color; 
          tok.setAttribute('data-p', String(t.idx)); 
          tok.textContent = t.player.name;
          
          // ‰∏çÂêåÁé©ÂÆ∂‰ΩøÁî®‰∏çÂêåÂΩ¢ÁãÄÂíåÂãïÁï´
          if (t.idx === 0) {
            // Áé©ÂÆ∂ 1: ÂúìÂΩ¢ - ÊóãËΩâËÑàË°ù
            tok.style.borderRadius = '50%';
            tok.style.animation = 'player1Pulse 3s ease-in-out infinite';
          } else if (t.idx === 1) {
            // Áé©ÂÆ∂ 2: ÊñπÂΩ¢ - ÁøªËΩâ
            tok.style.borderRadius = '6px';
            tok.style.animation = 'player2Flip 4s ease-in-out infinite';
            tok.style.transformStyle = 'preserve-3d';
          } else if (t.idx === 2) {
            // Áé©ÂÆ∂ 3: ‰∏âËßíÂΩ¢ - ÂΩàË∑≥
            tok.style.borderRadius = '0';
            tok.style.clipPath = 'polygon(50% 0%, 0% 100%, 100% 100%)';
            tok.style.animation = 'player3Bounce 2s ease-in-out infinite';
          } else if (t.idx === 3) {
            // Áé©ÂÆ∂ 4: Ëè±ÂΩ¢ - ÊêñÊì∫
            tok.style.borderRadius = '0';
            tok.style.animation = 'player4Swing 3s ease-in-out infinite';
            var inner = document.createElement('span');
            inner.textContent = tok.textContent;
            inner.style.transform = 'rotate(-45deg)';
            inner.style.display = 'inline-block';
            tok.textContent = '';
            tok.appendChild(inner);
          }
          
          // Â§öÂÄãÊ£ãÂ≠êÊôÇÁ∏ÆÂ∞è
          if (tokens.length > 1) {
            var size = tokens.length === 2 ? '28px' : (tokens.length === 3 ? '24px' : '20px');
            tok.style.width = size;
            tok.style.height = size;
            tok.style.fontSize = tokens.length === 2 ? '12px' : (tokens.length === 3 ? '10px' : '9px');
          }
          
          container.appendChild(tok);
        });
        
        cell.appendChild(container);
      });
    }
    
    // Ê£ãÂ≠êÁßªÂãïÂãïÁï´
    function animateTokenMove(playerIdx, steps, callback) {
      // Á∏ÆÂ∞èÈù¢Êùø
      var panel = document.querySelector('.center-panel');
      if (panel && !panel.classList.contains('collapsed')) {
        panel.classList.add('minimized');
      }
      
      function moveStep(remainingSteps) {
        if (remainingSteps <= 0) {
          // ÊÅ¢Âæ©Èù¢Êùø
          setTimeout(function() {
            if (panel) panel.classList.remove('minimized');
            // ÁßªÈô§ÊâÄÊúâÊ£ãÂ≠êÁöÑ moving class
            $$('.token').forEach(function(tok){ tok.classList.remove('moving'); });
          }, 300);
          if (callback) callback();
          return;
        }
        
        var p = state.players[playerIdx];
        p.pos = (p.pos + 1) % 40;
        renderTokens();
        
        // Ê∑ªÂä†ÁßªÂãïÊïàÊûúÂà∞Áï∂ÂâçÊ£ãÂ≠ê
        $$('.token').forEach(function(tok){ tok.classList.remove('moving'); });
        var currentToken = document.querySelector('.token[data-p="' + playerIdx + '"]');
        if (currentToken) {
          currentToken.classList.add('moving');
        }
        
        setTimeout(function() {
          moveStep(remainingSteps - 1);
        }, 400);
      }
      
      moveStep(steps);
    }
    function updateOwners(){
      // ÁßªÈô§ÊâÄÊúâÊ†ºÂ≠êÁöÑ owned class
      $$('.tile').forEach(function(tile){ tile.classList.remove('owned'); tile.style.backgroundColor = ''; });
      $$('.owner').forEach(function(el){ el.style.display='none'; });
      
      for (var pi=0;pi<state.players.length;pi++){ 
        var pl=state.players[pi]; 
        if (!pl.alive) continue; 
        
        for (var j=0;j<pl.properties.length;j++){ 
          var idx=pl.properties[j]; 
          
          // ‰ΩøÁî® data-tile-idx Â±¨ÊÄßÁ≤æÁ¢∫ÂÆö‰ΩçÊ†ºÂ≠ê
          var tile=document.querySelector('.tile[data-tile-idx="'+idx+'"]');
          if (tile) {
            // Ê∑ªÂä† owned class ‰∏¶Ë®≠ÁΩÆËÉåÊôØËâ≤
            tile.classList.add('owned');
            tile.style.backgroundColor = pl.color;
            
            // Êõ¥Êñ∞ owner Â∞èÂúìÈªû
            var ownerEl=tile.querySelector('.owner');
            if (ownerEl){ 
              ownerEl.style.display='block'; 
              ownerEl.style.background=pl.color; 
            }
          }
        } 
      }
    }
    function renderHouses(){
      $$('.house-stack').forEach(function(s){ s.innerHTML=''; });
      Object.keys(state.houses).forEach(function(k){
        var idx=Number(k), n=state.houses[k]|0; if (!n) return;
        var holder=document.querySelector('.house-stack[data-hidx="'+idx+'"]'); if (!holder) return;
        if (n===5){ var h=document.createElement('div'); h.className='hotel'; holder.appendChild(h); return; }
        for (var i=0;i<n;i++){ var x=document.createElement('div'); x.className='house'; holder.appendChild(x); }
      });
    }

    function renderPlayers(){
      var panel=document.getElementById('playersPanel'); 
      var html=""; 
      for (var i=0;i<state.players.length;i++){ 
        var p=state.players[i]; 
        if (!p.alive) continue; 
        
        // ÂâµÂª∫ÂΩ¢ÁãÄÊ®ôË®ò
        var shapeStyle = 'width: 20px; height: 20px; background:' + p.color + '; display: inline-block; margin-right: 8px;';
        if (i === 0) {
          shapeStyle += ' border-radius: 50%;'; // ÂúìÂΩ¢
        } else if (i === 1) {
          shapeStyle += ' border-radius: 3px;'; // ÊñπÂΩ¢
        } else if (i === 2) {
          shapeStyle += ' clip-path: polygon(50% 0%, 0% 100%, 100% 100%);'; // ‰∏âËßíÂΩ¢
        } else if (i === 3) {
          shapeStyle += ' transform: rotate(45deg);'; // Ëè±ÂΩ¢
        }
        
        html+='<div class="row"><div class="swatch" style="'+shapeStyle+'"></div><div class="name">'+(i===state.cur?"‚≠ê ":"")+p.name+(p.inJail?"ÔºàÁçÑÔºâ":"")+(p.outCard>0?"üÉè":"")+'</div><div class="cash">$'+p.cash+'</div></div>'; 
      } 
      panel.innerHTML=html; 
      document.getElementById('currentPlayer').textContent = state.players[state.cur].name;
    }
    function toast(msg){ var t=document.getElementById('toast'); if (!t) return; t.textContent=msg; t.classList.remove('hidden'); clearTimeout(toast._tid); toast._tid=setTimeout(function(){ t.classList.add('hidden'); }, 1500); }
    function log(msg, highlightMe){ if (highlightMe===void 0) highlightMe=false; var logEl=document.getElementById('log'); var div=document.createElement('div'); div.className='entry'+(highlightMe?' me':''); div.textContent=msg; logEl.prepend(div); toast(msg); }

    function endTurn(){ var p=state.players[state.cur]; p.rentBonusTemp=0; nextPlayer(); }
    function nextPlayer(){ state.justBought=[]; state.hasUpgradedThisTurn=false; do { state.cur=(state.cur+1)%state.players.length; } while(!state.players[state.cur].alive); state.dice=[0,0]; state.doublesInRow=0; state.awaitingBuy=false; state.mustEnd=false; renderPlayers(); $('#btnRoll').disabled = state.players[state.cur].isAI; $('#btnEnd').disabled = true; $('#btnBuy').disabled = true; $('#btnSkip').disabled = true; $('#dice1').textContent='-'; $('#dice2').textContent='-'; $('#turnInfo').textContent=''; if (checkWin()) return; if (state.players[state.cur].isAI) { aiTurn(); } else { if (state.players[state.cur].inJail) showJailOptions(state.players[state.cur]); } }
    function checkWin(){ var alive=state.players.filter(function(p){ return p.alive; }); if (alive.length===1){ showModal('üèÜ '+alive[0].name+' Áç≤ÂãùÔºÅÔºàÂÖ∂‰ªñÁé©ÂÆ∂ÁöÜÂ∑≤Á†¥Áî¢Ôºâ'); $('#btnRoll').disabled=true; $('#btnEnd').disabled=true; return true; } return false; }

    function showModal(html, withCancel){ if (withCancel===void 0) withCancel=false; $('#modalBody').innerHTML=html; $('#modal').classList.remove('hidden'); $('#modalCancel').style.display = withCancel?'inline-flex':'none';
      return new Promise(function(resolve){ function ok(){ $('#modal').classList.add('hidden'); $('#modalOk').removeEventListener('click', ok); $('#modalCancel').removeEventListener('click', cancel); resolve(true); } function cancel(){ $('#modal').classList.add('hidden'); $('#modalOk').removeEventListener('click', ok); $('#modalCancel').removeEventListener('click', cancel); resolve(false); } $('#modalOk').addEventListener('click', ok, {once:true}); $('#modalCancel').addEventListener('click', cancel, {once:true}); });
    }

    // ---- Êñ∞ÈÅäÊà≤ÊµÅÁ®ã ----
    var selectedPlayerCount = 0;
    var selectedCharacter = null;
    
    // 1. ÈÅ∏ÊìáÈÅäÊà≤‰∫∫Êï∏
    function showPlayerCountSelection() {
      var html = '<h2 style="text-align:center;">üéÆ Êñ∞ÈÅäÊà≤</h2>';
      html += '<p style="text-align:center;">Ë´ãÈÅ∏ÊìáÈÅäÊà≤‰∫∫Êï∏Ôºö</p>';
      html += '<div style="display:flex;gap:16px;justify-content:center;margin-top:20px;flex-wrap:wrap;">';
      html += '<button class="player-count-btn" data-count="2" style="padding:20px 40px;font-size:18px;border:2px solid #ddd;border-radius:8px;background:white;cursor:pointer;white-space:nowrap;min-width:160px;">üë• 2‰∫∫Â∞çÊà∞</button>';
      html += '<button class="player-count-btn" data-count="3" style="padding:20px 40px;font-size:18px;border:2px solid #ddd;border-radius:8px;background:white;cursor:pointer;white-space:nowrap;min-width:160px;">üë• 3‰∫∫Â∞çÊà∞</button>';
      html += '<button class="player-count-btn" data-count="4" style="padding:20px 40px;font-size:18px;border:2px solid #ddd;border-radius:8px;background:white;cursor:pointer;white-space:nowrap;min-width:160px;">üë• 4‰∫∫Â∞çÊà∞</button>';
      html += '</div>';
      
      showModal(html, false);
      
      setTimeout(function() {
        var btns = document.querySelectorAll('.player-count-btn');
        btns.forEach(function(btn) {
          btn.addEventListener('mouseenter', function() {
            this.style.borderColor = '#4CAF50';
            this.style.transform = 'scale(1.05)';
          });
          btn.addEventListener('mouseleave', function() {
            this.style.borderColor = '#ddd';
            this.style.transform = 'scale(1)';
          });
          btn.addEventListener('click', function() {
            selectedPlayerCount = parseInt(this.getAttribute('data-count'));
            document.getElementById('modal').classList.add('hidden');
            showCharacterSelection();
          });
        });
      }, 100);
    }
    
    // 2. ÈÅ∏ÊìáËßíËâ≤
    function showCharacterSelection() {
      var html = '<h2>üé≠ ÈÅ∏Êìá‰Ω†ÁöÑËßíËâ≤</h2>';
      html += '<p>Ë´ãÈÅ∏Êìá‰∏ÄÂÄãËßíËâ≤ÔºàAI ÊúÉËá™ÂãïÈÅ∏ÊìáÂÖ∂‰ªñËßíËâ≤ÔºâÔºö</p>';
      html += '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:16px;max-height:400px;overflow-y:auto;">';
      
      CHARACTERS.forEach(function(char) {
        html += '<button class="char-btn" data-char="' + char.id + '" style="padding:12px;border:2px solid #ddd;border-radius:8px;background:white;cursor:pointer;text-align:center;">';
        html += '<div style="font-size:32px;">' + char.emoji + '</div>';
        html += '<div style="font-size:14px;margin-top:4px;">' + char.name + '</div>';
        html += '</button>';
      });
      
      html += '</div>';
      
      showModal(html, false);
      
      setTimeout(function() {
        var btns = document.querySelectorAll('.char-btn');
        btns.forEach(function(btn) {
          btn.addEventListener('mouseenter', function() {
            this.style.borderColor = '#4CAF50';
            this.style.transform = 'scale(1.05)';
          });
          btn.addEventListener('mouseleave', function() {
            this.style.borderColor = '#ddd';
            this.style.transform = 'scale(1)';
          });
          btn.addEventListener('click', function() {
            var charId = this.getAttribute('data-char');
            selectedCharacter = CHARACTERS.find(function(c) { return c.id === charId; });
            document.getElementById('modal').classList.add('hidden');
            showMapSelection();
          });
        });
      }, 100);
    }
    
    // ---- Âú∞ÂúñÈÅ∏ÊìáÁïåÈù¢ ----
    function showMapSelection() {
      var html = '<h2>üó∫Ô∏è ÈÅ∏ÊìáÂú∞Âúñ</h2>';
      html += '<p>Ë´ãÈÅ∏Êìá‰Ω†ÊÉ≥ÈÅäÁé©ÁöÑÂú∞ÂúñÔºö</p>';
      html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px;">';
      
      var mapList = [
        {key: 'taiwan', name: 'üáπüáº Âè∞ÁÅ£', desc: 'ÂØ∂Â≥∂È¢®ÂÖâ'},
        {key: 'japan', name: 'üáØüáµ Êó•Êú¨', desc: 'Ê´ªËä±‰πãÂúã'},
        {key: 'usa', name: 'üá∫üá∏ ÁæéÂúã', desc: 'Ëá™Áî±‰πãÂú∞'},
        {key: 'hongkong', name: 'üá≠üá∞ È¶ôÊ∏Ø', desc: 'Êù±Êñπ‰πãÁè†'},
        {key: 'vietnam', name: 'üáªüá≥ Ë∂äÂçó', desc: 'ÂçóÊ¥ãÈ¢®ÊÉÖ'},
        {key: 'korea', name: 'üá∞üá∑ ÈüìÂúã', desc: 'Êº¢Ê±üÂ•áËπü'},
        {key: 'italy', name: 'üáÆüáπ Áæ©Â§ßÂà©', desc: 'ÊñáËóùÂæ©Ëàà'},
        {key: 'netherlands', name: 'üá≥üá± Ëç∑Ëò≠', desc: 'È¢®Ëªä‰πãÂúã'},
        {key: 'russia', name: 'üá∑üá∫ ‰øÑÁæÖÊñØ', desc: 'Âª£ÈóäÂ§ßÂú∞'},
        {key: 'galaxy', name: 'üåå ÈäÄÊ≤≥Á≥ª', desc: 'ÂÆáÂÆôÊé¢Á¥¢'}
      ];
      
      mapList.forEach(function(map) {
        html += '<button class="map-btn" data-map="' + map.key + '" style="padding:16px;font-size:16px;border:2px solid #ddd;border-radius:8px;background:white;cursor:pointer;transition:all 0.2s;">';
        html += '<div style="font-size:24px;margin-bottom:8px;">' + map.name + '</div>';
        html += '<div style="font-size:14px;color:#666;">' + map.desc + '</div>';
        html += '</button>';
      });
      
      html += '</div>';
      
      showModal(html, false);
      
      // Ê∑ªÂä†ÊåâÈàï‰∫ã‰ª∂
      setTimeout(function() {
        var mapBtns = document.querySelectorAll('.map-btn');
        mapBtns.forEach(function(btn) {
          btn.addEventListener('mouseenter', function() {
            this.style.borderColor = '#4CAF50';
            this.style.transform = 'scale(1.05)';
          });
          btn.addEventListener('mouseleave', function() {
            this.style.borderColor = '#ddd';
            this.style.transform = 'scale(1)';
          });
          btn.addEventListener('click', function() {
            var mapKey = this.getAttribute('data-map');
            currentMap = mapKey;
            tiles = generateTiles(currentMap);
            document.getElementById('modal').classList.add('hidden');
            initPlayersWithSelection();
            setTimeout(addButtonSounds, 500);
            buildBoard();
            renderTokens();
            $('#btnRoll').disabled=false; 
            $('#btnEnd').disabled=true; 
            $('#btnBuy').disabled=true; 
            $('#btnSkip').disabled=true; 
            $('#dice1').textContent='-'; 
            $('#dice2').textContent='-'; 
            $('#turnInfo').textContent=''; 
            $('#log').innerHTML='';
            log('üó∫Ô∏è Â∑≤ÈÅ∏ÊìáÂú∞ÂúñÔºö' + MAPS[mapKey].name, false);
          });
        });
      }, 100);
    }

    // ---- Êì≤È™∞ËàáÁßªÂãïÔºàÈÄêÊ†ºÂãïÁï´Ôºâ ----
    function rollDice(){ var d1=1+Math.floor(Math.random()*6), d2=1+Math.floor(Math.random()*6); state.dice=[d1,d2]; $('#dice1').textContent=d1; $('#dice2').textContent=d2; return [d1,d2]; }
    async function onRoll(){ try{playSound("roll");}catch(e){}  var p=state.players[state.cur]; if (p.inJail) return {again:false}; $('#btnRoll').disabled=true; var d=rollDice(), d1=d[0], d2=d[1]; var isDouble=d1===d2; if (isDouble){ state.doublesInRow++; if (state.doublesInRow>=3){ log('‚ö†Ô∏è '+p.name+' ÈÄ£Á∫åÁ¨¨‰∏âÊ¨°Êì≤Âá∫ÈõôÈ™∞ÔºåË¢´ÈÄÅÂÖ•ÁçÑ„ÄÇ', !p.isAI); goToJail(p); $('#btnEnd').disabled=false; return {again:false}; } } else { state.doublesInRow=0; } await moveSteps(p, d1+d2); await resolveTile(p, d1+d2); if (isDouble && p.alive && !p.inJail){ $('#turnInfo').textContent='ÈõôÈ™∞ÔºÅ‰Ω†ÂèØÂÜçÊì≤‰∏ÄÊ¨°„ÄÇ'; $('#btnRoll').disabled=false; $('#btnEnd').disabled=true; return {again:true}; } else { $('#btnEnd').disabled=false; return {again:false}; } }
    async function moveSteps(p, steps){ 
      var playerIdx = state.players.indexOf(p);
      return new Promise(function(resolve) {
        animateTokenMove(playerIdx, steps, function() {
          // Ê™¢Êü•ÊòØÂê¶Á∂ìÈÅéËµ∑Èªû
          var passedGo = false;
          for (var i = 0; i < steps; i++) {
            var oldPos = (p.pos - steps + i + 40) % 40;
            var newPos = (oldPos + 1) % 40;
            if (newPos === 0) passedGo = true;
          }
          if (passedGo) {
            var bonus=START_SALARY; 
            var bi=state.bonusNextGo.indexOf(p.id); 
            if (bi>=0){ bonus+=3300; state.bonusNextGo.splice(bi,1); } 
            p.cash+=bonus; 
            renderPlayers(); 
            log('üíµ '+p.name+' Á∂ìÈÅéËµ∑ÈªûÔºåÈ†ò $'+bonus, !p.isAI);
          }
          resolve();
        });
      });
    }

    // ---- ÊâÄÊúâÊ¨äËàáÁæ§ÁµÑ ----
    function ownerOf(idx){ for (var i=0;i<state.players.length;i++){ var pl=state.players[i]; if (!pl.alive) continue; if (pl.properties.indexOf(idx)>=0) return i; } return -1; }
    function groupSlots(groupId){ return tiles.filter(function(t){ return t.type==="PROPERTY" && t.group===groupId; }).map(function(t){ return t.idx; }); }
    function groupOwnedCount(ownerIdx, groupId){ var slots=groupSlots(groupId); var pl=state.players[ownerIdx]; var cnt=0; for (var k=0;k<slots.length;k++){ var idx=slots[k]; if (pl.properties.indexOf(idx)>=0 && pl.mortgaged.indexOf(idx)<0) cnt++; } return {cnt:cnt,total:slots.length}; }
    function hasMonopoly(ownerIdx, groupId){ var g=groupOwnedCount(ownerIdx, groupId); return g.cnt===g.total && g.total>0; }

    // ---- Âª∫Â±ãÔºèË≥£Â±ãÈÇèËºØ ----
    function houseCount(idx){ return state.houses[idx]|0; }
    function canBuildHere(p, idx){
      var t=tiles[idx]; if (t.type!=="PROPERTY") return false;
      if (p.properties.indexOf(idx)<0) return false;
      if (p.mortgaged.indexOf(idx)>=0) return false;
      // ÁßªÈô§Â£üÊñ∑ÈôêÂà∂ÔºöÂè™Ë¶ÅÊìÅÊúâÂú∞Áî¢Â∞±ËÉΩÂçáÁ¥ö
      // if (!hasMonopoly(state.cur, t.group)) return false;
      var n=houseCount(idx); if (n>=5) return false;
      // ÁßªÈô§ÂùáË°°Âª∫Â±ãÈôêÂà∂ÔºöÂèØ‰ª•Ëá™Áî±ÂçáÁ¥ö
      // var gs=groupSlots(t.group); var arr=gs.map(houseCount);
      // return n<=Math.min.apply(null, arr)+1;
      return true;
    }
    function canSellHouseHere(p, idx){
      var t=tiles[idx]; if (t.type!=="PROPERTY") return false;
      if (p.properties.indexOf(idx)<0) return false;
      var n=houseCount(idx); if (n<=0) return false;
      // ÁßªÈô§ÂùáË°°Ë≥£Â±ãÈôêÂà∂ÔºöÂèØ‰ª•Ëá™Áî±Ë≥£Â±ã
      // var gs=groupSlots(t.group); var arr=gs.map(houseCount); var max=Math.max.apply(null, arr);
      // return n===max;
      return true;
    }
    function buildCost(idx){ var g=tiles[idx].group; return HOUSE_COST[g]||150; }
    function sellValue(idx){ return Math.floor(buildCost(idx)*0.5); }

    // ---- Âú∞Ê†ºËôïÁêÜ ----
    async function resolveTile(p, diceTotal){
      var t=tiles[p.pos];
      if (t.type==="PROPERTY") await onLandProperty(p,t);
      else if (t.type==="STATION") await onLandStation(p,t);
      else if (t.type==="UTILITY") await onLandUtility(p,t,diceTotal);
      else if (t.type==="TAX") await payToBank(p,t.amount,'Á®ÖÈáë');
      else if (t.type==="CHANCE") await drawCard(p, chanceDeck, 'Ê©üÊúÉ', diceTotal);
      else if (t.type==="CHEST") await drawCard(p, chestDeck, 'ÂëΩÈÅã', diceTotal);
      else if (t.type==="GOTOJAIL") goToJail(p);
      else if (t.type==="JAIL") log(p.name+' Âè™ÊòØ‰æÜÊé¢Áõ£„ÄÇ', !p.isAI);
      else if (t.type==="FREE") log(p.name+' Êñº‰ºëÊÅØÂçÄÊîæÈ¨ÜÁâáÂàª„ÄÇ', !p.isAI);
    }

    function rentForProperty(ownerIdx, t){
      var base = baseRent(t.price);
      var h = houseCount(t.idx);
      if (h>0) return base * HOUSE_MULT[clamp(h,0,5)];
      // ÁÑ°ÊàøÔºöËã•ÊìÅÊúâÊï¥ÁµÑÔºåÁßüÈáë *2
      var mono = hasMonopoly(ownerIdx, t.group);
      return base * (mono?2:1);
    }

    // ---- Ëß∏Âú∞ÈÇèËºØ ----
    async function onLandProperty(p,t){
      var idx=t.idx, ownerIdx=ownerOf(idx);
      if (ownerIdx<0){
        if (!p.isAI){
          var canBuy=p.cash>=t.price; $('#btnBuy').disabled=!canBuy; $('#btnSkip').disabled=false; state.awaitingBuy=true; $('#turnInfo').textContent=canBuy?('ÂèØÁî® $'+t.price+' Ë≥ºË≤∑„Ää'+t.name+'„Äã'):'Ë≥áÈáë‰∏çË∂≥ÔºåÁÑ°Ê≥ïË≥ºË≤∑„ÄÇ';
        } else {
          if (aiShouldBuyProperty(p,t)) buyProperty(p, idx, t.price); else log('ü§î '+p.name+' ÊîæÊ£ÑË≥ºË≤∑„Ää'+t.name+'„Äã', true);
        }
      } else if (ownerIdx===state.cur){
        log(p.name+' ‰æÜÂà∞Ëá™Â∑±ÁöÑÂú∞„Ää'+t.name+'„Äã„ÄÇ', !p.isAI);
      } else {
        var owner=state.players[ownerIdx]; if (owner.mortgaged.indexOf(idx)>=0){ log('„Ää'+t.name+'„ÄãÂ∑≤ÊäµÊäºÔºåÂÖçÁßü„ÄÇ', !p.isAI); return; }
        var rent=rentForProperty(ownerIdx, t) + (owner.rentBonusTemp||0);
        await payToPlayer(p, owner, rent, 'ÁßüÈáëÔºö„Ää'+t.name+'„Äã');
      }
    }
    async function onLandStation(p,t){
      var idx=t.idx, ownerIdx=ownerOf(idx);
      if (ownerIdx<0){
        var price=6600;  // $200 * 33 = $6600
        if (!p.isAI){ $('#turnInfo').textContent='ÂèØÁî® $'+price+' Ë≥ºË≤∑„Ää'+t.name+'„Äã'; state.awaitingBuy=true; $('#btnBuy').disabled=!(p.cash>=price); $('#btnSkip').disabled=false; }
        else { if (aiShouldBuyStation(p)) buyProperty(p, idx, price); else log('ü§î '+p.name+' ÊîæÊ£ÑË≥ºË≤∑„Ää'+t.name+'„Äã', true); }
      } else if (ownerIdx===state.cur){
        log(p.name+' ‰æÜÂà∞Ëá™Â∑±ÁöÑ„Ää'+t.name+'„Äã„ÄÇ', !p.isAI);
      } else {
        var owner=state.players[ownerIdx]; if (owner.mortgaged.indexOf(idx)>=0){ log('„Ää'+t.name+'„ÄãÂ∑≤ÊäµÊäºÔºåÂÖçÁßü„ÄÇ', !p.isAI); return; }
        var ownerStations=[5,15,25,35].filter(function(s){ return owner.properties.indexOf(s)>=0 && owner.mortgaged.indexOf(s)<0; }).length;
        var rent=STATION_RENTS[clamp(ownerStations-1,0,3)] + (owner.rentBonusTemp||0);
        await payToPlayer(p, owner, rent, 'ËªäÁ´ôÁßüÈáëÔºö„Ää'+t.name+'„Äã');
      }
    }
    async function onLandUtility(p,t,diceTotal){
      var idx=t.idx, ownerIdx=ownerOf(idx);
      if (ownerIdx<0){
        var price=5000;  // $150 * 33 ‚âà $5000
        if (!p.isAI){ $('#turnInfo').textContent='ÂèØÁî® $'+price+' Ë≥ºË≤∑„Ää'+t.name+'„Äã'; state.awaitingBuy=true; $('#btnBuy').disabled=!(p.cash>=price); $('#btnSkip').disabled=false; }
        else { if (aiShouldBuyUtility(p)) buyProperty(p, idx, price); else log('ü§î '+p.name+' ÊîæÊ£ÑË≥ºË≤∑„Ää'+t.name+'„Äã', true); }
      } else if (ownerIdx===state.cur){
        log(p.name+' ‰æÜÂà∞Ëá™Â∑±ÁöÑ„Ää'+t.name+'„Äã„ÄÇ', !p.isAI);
      } else {
        var owner=state.players[ownerIdx]; if (owner.mortgaged.indexOf(idx)>=0){ log('„Ää'+t.name+'„ÄãÂ∑≤ÊäµÊäºÔºåÂÖçÁßü„ÄÇ', !p.isAI); return; }
        var both=[12,28].every(function(u){ return owner.properties.indexOf(u)>=0 && owner.mortgaged.indexOf(u)<0; });
        var rate=both?330:132; var rent=diceTotal*rate + (owner.rentBonusTemp||0);  // ÂéüÁâà 10 Âíå 4Ôºå* 33 = 330 Âíå 132
        await payToPlayer(p, owner, rent, '‰∫ãÊ•≠Ë≤ªÁî®Ôºö„Ää'+t.name+'„Äã '+rate+'√óÈªûÊï∏');
      }
    }

    // ---- ‰ªòÊ¨æËàáÁ†¥Áî¢ ----
    async function payToBank(p, amount, reason){ if (amount<=0) return; log('üè¶ '+p.name+' ÊîØ‰ªòÈäÄË°å $'+amount+'Ôºà'+reason+'Ôºâ', !p.isAI); await ensureCash(p, amount); if (!p.alive) return; p.cash-=amount; renderPlayers(); }
    async function payToPlayer(payer,receiver,amount,reason){
      if (amount<=0) return; log('üí∏ '+payer.name+' ÊîØ‰ªò $'+amount+' Áµ¶ '+receiver.name+'Ôºà'+reason+'Ôºâ', !payer.isAI);
      await ensureCash(payer, amount, receiver); if (!payer.alive) return; payer.cash-=amount; receiver.cash+=amount; renderPlayers();
    }
    async function ensureCash(p, need, creditor){
      if (p.cash >= need) return;
      // ÂÖàË≥£Â±ãÔºàÂæûÈ´òÂÉπÁæ§„ÄÅÊàøÊï∏Â§öËÄÖÈñãÂßãÔºõÂùáË°°Ë¶èÂâáÂèçÂêëÔºâ
      var propWithHouses = p.properties.filter(function(idx){ return (state.houses[idx]|0) > 0; });
      // sort by cost desc then house count desc
      propWithHouses.sort(function(a,b){
        var ca = buildCost(a), cb = buildCost(b);
        var ha = houseCount(a), hb = houseCount(b);
        if (cb!==ca) return cb-ca;
        return hb-ha;
      });
      for (var i=0;i<propWithHouses.length && p.cash<need;i++){
        var idx = propWithHouses[i];
        if (canSellHouseHere(p, idx)){
          state.houses[idx] = houseCount(idx)-1;
          var val = sellValue(idx);
          p.cash += val;
          renderHouses(); renderPlayers();
          log('üîß '+p.name+' Âá∫ÂîÆ‰∏ÄÊ£üÊàøÔºà„Ää'+tiles[idx].name+'„ÄãÔºâÔºåÂõûÊî∂ $'+val, !p.isAI);
          i = -1; // ÈáçÊñ∞ÊéíÂ∫èÔºå‰ª•Á¨¶ÂêàÂùáË°°Ë≥£Â±ã
          propWithHouses = p.properties.filter(function(x){ return (state.houses[x]|0) > 0; });
          propWithHouses.sort(function(a,b){
            var ca = buildCost(a), cb = buildCost(b);
            var ha = houseCount(a), hb = houseCount(b);
            if (cb!==ca) return cb-ca;
            return hb-ha;
          });
        }
      }
      if (p.cash >= need) return;
      // ÂÜçÊäµÊäº
      var candidates = p.properties.filter(function(idx){ return p.mortgaged.indexOf(idx)<0 && (state.houses[idx]|0)===0; })
        .map(function(idx){ return {idx:idx, price:getPrice(tiles[idx])}; })
        .sort(function(a,b){ return a.price - b.price; });
      for (var j=0;j<candidates.length && p.cash<need;j++){
        doMortgage(p, candidates[j].idx);
        await sleep(60);
      }
      if (p.cash >= need) return;
      // ÂÖ®ÈÉ®ÊâãÊÆµÁî®Áõ°ÔºöÁ†¥Áî¢
      if (creditor){
        for (var k=0;k<p.properties.length;k++){
          var idx2 = p.properties[k];
          if (creditor.properties.indexOf(idx2)<0) creditor.properties.push(idx2);
          if (p.mortgaged.indexOf(idx2)>=0 && creditor.mortgaged.indexOf(idx2)<0) creditor.mortgaged.push(idx2);
          if (state.houses[idx2]){ // ÊàøÂ±ãÈö®Áî¢Áßª‰∫§
            state.houses[idx2] = state.houses[idx2]; // keep same
          }
        }
      } else {
        // Êî∂Ê≠∏ÈäÄË°åÔºöÊ∏ÖÈô§ÊàøÂ±ã
        p.properties.forEach(function(x){ delete state.houses[x]; });
      }
      p.properties = []; p.mortgaged = []; p.cash = 0; p.alive = false;
      renderPlayers(); updateOwners(); renderHouses(); renderTokens();
      log('üí• '+p.name+' ÁÑ°ÂäõÊîØ‰ªòÔºåÂÆ£ÂëäÁ†¥Áî¢'+(creditor?('ÔºåË≥áÁî¢Áßª‰∫§Áµ¶ '+creditor.name):'ÔºåË≥áÁî¢Êî∂Ê≠∏ÈäÄË°å')+'„ÄÇ', !p.isAI);
    }

    function doMortgage(p, idx){ var t=tiles[idx]; if (p.properties.indexOf(idx)<0 || p.mortgaged.indexOf(idx)>=0) return; if (houseCount(idx)>0) return; var val=Math.floor(getPrice(t)*0.5); p.mortgaged.push(idx); p.cash+=val; renderPlayers(); log('üè¶ '+p.name+' ÊäµÊäº„Ää'+(t.name||t.label)+'„ÄãÔºåÂèñÂæó $'+val, !p.isAI); }
    function doUnmortgage(p, idx){ var t=tiles[idx]; var mi=p.mortgaged.indexOf(idx); if (mi<0) return; var cost=Math.floor(getPrice(t)*0.5*1.1); if (p.cash<cost){ log('ÁèæÈáë‰∏çË∂≥ÔºåÁÑ°Ê≥ïË¥ñÂõû„ÄÇ', !p.isAI); return; } p.cash-=cost; p.mortgaged.splice(mi,1); renderPlayers(); log('üí≥ '+p.name+' Ë¥ñÂõû„Ää'+(t.name||t.label)+'„ÄãÔºåÊîØ‰ªò $'+cost, !p.isAI); }
    function goToJail(p){ p.inJail=true; p.jailTurns=0; p.pos=10; renderTokens(); $('#turnInfo').textContent=p.name+' ÂÖ•ÁçÑ„ÄÇ'; }

    // ---- Âç°ÁâåÔºà‰øùÁïôÂéüÈÇèËºØÔºåÈáëÈ°çÊ≤øÁî®Êñ∞ÂèÉÊï∏Ôºâ ----
    var chestDeck = shuffle([
      {t:"cash",v:+200,text:"ÂüéÂ∏ÇË£úÂä©ÔºåÈ†ò $6600",rarity:"common",emoji:"üè¶"},
      {t:"cash",v:+100,text:"ÈÄÄÁ®ÖÔºåÈ†ò $3300",rarity:"common",emoji:"üíµ"},
      {t:"cash",v:-3300,text:"ÈÜ´ÁôÇË≤ªÔºå‰ªò $3300",rarity:"common",emoji:"üè•"},
      {t:"cash",v:+150,text:"ÂÖ¨Âè∏Á¥ÖÂà©ÔºåÈ†ò $5000",rarity:"rare",emoji:"üíº"},
      {t:"cash",v:-1650,text:"ÁΩ∞Ê¨æÔºå‰ªò $1650",rarity:"common",emoji:"‚ö†Ô∏è"},
      {t:"moveTo",idx:0,text:"ÂâçÈÄ≤Âà∞Ëµ∑Èªû‰∏¶È†òËñ™",rarity:"common",emoji:"üèÅ"},
      {t:"jail",text:"Áõ¥Êé•ÂÖ•ÁçÑ",rarity:"common",emoji:"üëÆ"},
      {t:"outCard",text:"Áç≤ÂæóÂá∫ÁçÑÂç°",rarity:"rare",emoji:"üîë"},
      {t:"collectFromEach",v:1650,text:"È°ßÂïèË≤ªÔºöÊØè‰ΩçÁé©ÂÆ∂‰ªò‰Ω† $1650",rarity:"epic",emoji:"üí∞"},
      {t:"payToEach",v:825,text:"ÊçêÂä©Ôºö‰Ω†‰ªòÊØè‰ΩçÁé©ÂÆ∂ $825",rarity:"common",emoji:"ü§ù"},
      {t:"nearestUtility",text:"ÂâçÈÄ≤Âà∞ÊúÄËøëÁöÑ‰∫ãÊ•≠Ê†ºÔºàËã•Êúâ‰∏ª‰ªò 10√óÈªûÊï∏ÔºõÁÑ°‰∏ªÂèØË≤∑Ôºâ",rarity:"rare",emoji:"‚ö°"},
      {t:"freeRent",turns:2,text:"ÂÖçÁßüÈáëÂç°Ôºà2ÂõûÂêàÔºâ",rarity:"epic",emoji:"üåü"},
      {t:"teleport",text:"ÂÇ≥ÈÄÅÂç°ÔºöÂÇ≥ÈÄÅÂà∞‰ªªÊÑèÊ†ºÂ≠ê",rarity:"epic",emoji:"‚ú®"},
      {t:"cash",v:+500,text:"ÈÅ∫Áî¢ÁπºÊâøÔºåÁç≤Âæó $500",rarity:"epic",emoji:"üí∏"}
    ]);
    var chanceDeck = shuffle([
      {t:"moveTo",idx:0,text:"ÂâçÈÄ≤Âà∞Ëµ∑Èªû‰∏¶È†òËñ™",rarity:"common",emoji:"üèÅ"},
      {t:"nearestStation",text:"ÂâçÈÄ≤Âà∞ÊúÄËøëÁöÑËªäÁ´ôÔºà2√óÁßüÈáëÔºâ",rarity:"rare",emoji:"üöâ"},
      {t:"jail",text:"Áõ¥Êé•ÂÖ•ÁçÑ",rarity:"common",emoji:"üöî"},
      {t:"outCard",text:"Áç≤ÂæóÂá∫ÁçÑÂç°",rarity:"rare",emoji:"üîë"},
      {t:"cash",v:+150,text:"ÊäΩ‰∏≠ÂΩ©Âà∏ÔºåÈ†ò $5000",rarity:"common",emoji:"üé∞"},
      {t:"cash",v:-2500,text:"Êî∂Âà∞ÁΩ∞ÂñÆÔºå‰ªò $2500",rarity:"common",emoji:"üö®"},
      {t:"back3",text:"ÂõûÈÄÄ 3 Ê†º",rarity:"common",emoji:"‚è™"},
      {t:"payTax",v:6600,text:"Á®ÖÂãôÁ®ΩÊ†∏ÔºåÊîØ‰ªò $6600",rarity:"common",emoji:"üìã"},
      {t:"moveTo",idx:24,text:"ÂâçÈÄ≤Âà∞„ÄéËµ§ÂüéÈñÄ„Äè",rarity:"common",emoji:"üéØ"},
      {t:"moveTo",idx:39,text:"ÂâçÈÄ≤Âà∞„ÄéÈõ≤È†ÇÂ°î„Äè",rarity:"common",emoji:"üéØ"},
      {t:"marketRush",text:"Êî∂ÁßüÂ§ßÊúàÔºöÊú¨ÂõûÂêàÊî∂Áßü +$825",bonus:825,rarity:"rare",emoji:"üìà"},
      {t:"bonusNextGo",text:"‰∏ãÊ¨°Á∂ìÈÅéËµ∑Èªû +$3300",rarity:"common",emoji:"üí∞"},
      {t:"cash",v:10000,text:"ÊäïË≥áÁç≤Âà©ÔºåÁç≤Âæó $10000",rarity:"rare",emoji:"üìâ"},
      {t:"doubleRent",turns:1,text:"ÈõôÂÄçÊî∂ÁßüÂç°Ôºà1ÂõûÂêàÔºâ",rarity:"epic",emoji:"üíé"},
      {t:"swapPosition",text:"Ëàá‰ªªÊÑèÁé©ÂÆ∂‰∫§Êèõ‰ΩçÁΩÆ",rarity:"epic",emoji:"üîÑ"},
      {t:"protection",turns:2,text:"‰øùË≠∑Âç°ÔºöÂÖçÁñ´Ë≤†Èù¢Âç°ÁâåÔºà2ÂõûÂêàÔºâ",rarity:"epic",emoji:"üõ°Ô∏è"}
    ]);
    async function drawCard(p, deck, name, diceTotal){
      var card=deck.shift(); deck.push(card); 
      
      // Ë®òÈåÑÂà∞Êî∂Ëóè
      var collectionKey = name === 'Ê©üÊúÉ' ? 'chance' : 'chest';
      if (!state.cardCollection[collectionKey][card.text]) {
        state.cardCollection[collectionKey][card.text] = {
          card: card,
          count: 0,
          firstDrawn: Date.now()
        };
      }
      state.cardCollection[collectionKey][card.text].count++;
      
      // È°ØÁ§∫ËèØÈ∫óÂç°Áâå
      await showFancyCard(card, name);
      
      log('üìú '+p.name+' ÊäΩÂà∞ '+name+' Âç°Ôºö'+card.text, !p.isAI);
      switch(card.t){
        case "cash": if (card.v>=0){ p.cash+=card.v; renderPlayers(); } else { await payToBank(p, -card.v, name); } break;
        case "moveTo": await moveTo(p, card.idx, true); await resolveTile(p, 0); break;
        case "jail": goToJail(p); break;
        case "outCard": p.outCard+=1; renderPlayers(); break;
        case "collectFromEach": for (var i=0;i<state.players.length;i++){ var other=state.players[i]; if (other===p || !other.alive) continue; await payToPlayer(other, p, card.v, name+'Âç°'); } break;
        case "payToEach": for (var j=0;j<state.players.length;j++){ var o=state.players[j]; if (o===p || !o.alive) continue; await payToPlayer(p, o, card.v, name+'Âç°'); } break;
        case "nearestUtility": await moveToNearest(p, ["UTILITY"], diceTotal, true); break;
        case "nearestStation": await moveToNearest(p, ["STATION"], diceTotal, true, true); break;
        case "back3": await moveBack(p, 3); await resolveTile(p, diceTotal); break;
        case "payTax": await payToBank(p, card.v, name+'Âç°'); break;
        case "marketRush": p.rentBonusTemp += (card.bonus||25); $('#turnInfo').textContent='Êú¨ÂõûÂêàÊî∂Áßü +$825'; break;
        case "bonusNextGo": if (state.bonusNextGo.indexOf(p.id)<0) state.bonusNextGo.push(p.id); break;
        case "freeRent": 
          p.freeRentTurns = (p.freeRentTurns || 0) + (card.turns || 1);
          log(p.name + ' Áç≤ÂæóÂÖçÁßüÈáëÂç°Ôºà' + card.turns + 'ÂõûÂêàÔºâ', !p.isAI);
          break;
        case "doubleRent":
          p.doubleRentTurns = (p.doubleRentTurns || 0) + (card.turns || 1);
          log(p.name + ' Áç≤ÂæóÈõôÂÄçÊî∂ÁßüÂç°Ôºà' + card.turns + 'ÂõûÂêàÔºâ', !p.isAI);
          break;
        case "teleport":
          if (!p.isAI) {
            await showTeleportUI(p);
          } else {
            var randomPos = Math.floor(Math.random() * 40);
            await moveTo(p, randomPos, false);
            await resolveTile(p, diceTotal);
          }
          break;
        case "swapPosition":
          if (!p.isAI) {
            await showSwapUI(p);
          }
          break;
        case "protection":
          p.protectionTurns = (p.protectionTurns || 0) + (card.turns || 1);
          log(p.name + ' Áç≤Âæó‰øùË≠∑Âç°Ôºà' + card.turns + 'ÂõûÂêàÔºâ', !p.isAI);
          break;
      }
    }
    // ËèØÈ∫óÂç°ÁâåÈ°ØÁ§∫
    async function showFancyCard(card, deckName) {
      return new Promise(function(resolve) {
        var rarityColors = {
          common: 'linear-gradient(135deg, #a8b2d1 0%, #8892b0 100%)',
          rare: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
          epic: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)'
        };
        
        var rarityNames = {
          common: 'ÊôÆÈÄö',
          rare: 'Á®ÄÊúâ',
          epic: 'Âè≤Ë©©'
        };
        
        var rarity = card.rarity || 'common';
        var bgColor = rarityColors[rarity];
        var rarityName = rarityNames[rarity];
        
        var overlay = document.createElement('div');
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.8);
          z-index: 20000;
          display: flex;
          align-items: center;
          justify-content: center;
          animation: fadeIn 0.3s ease-out;
        `;
        
        var cardEl = document.createElement('div');
        cardEl.style.cssText = `
          width: 320px;
          height: 450px;
          background: ${bgColor};
          border-radius: 20px;
          padding: 30px;
          box-shadow: 0 30px 80px rgba(0,0,0,0.6), 0 0 0 3px rgba(255,255,255,0.3);
          animation: cardFlip 0.8s ease-out;
          position: relative;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: space-between;
          color: white;
          text-align: center;
        `;
        
        cardEl.innerHTML = `
          <div style="position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.3); padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">
            ${rarityName}
          </div>
          <div style="font-size: 14px; font-weight: bold; opacity: 0.9; margin-top: 10px;">
            ${deckName}Âç°
          </div>
          <div style="font-size: 100px; margin: 20px 0; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3));">
            ${card.emoji || 'üé¥'}
          </div>
          <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; gap: 15px;">
            <div style="font-size: 28px; font-weight: bold; text-shadow: 0 4px 8px rgba(0,0,0,0.3);">
              ${card.text.split('Ôºö')[0].split('Ôºå')[0]}
            </div>
            <div style="font-size: 16px; opacity: 0.95; line-height: 1.5; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 10px;">
              ${card.text}
            </div>
          </div>
          <button onclick="this.parentElement.parentElement.remove()" style="
            width: 100%;
            padding: 15px;
            background: rgba(255,255,255,0.9);
            color: #333;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
            transition: all 0.2s;
          " onmouseover="this.style.background='white'" onmouseout="this.style.background='rgba(255,255,255,0.9)'">
            Á¢∫ÂÆö
          </button>
        `;
        
        overlay.appendChild(cardEl);
        document.body.appendChild(overlay);
        
        playSound('purchase');
        
        overlay.querySelector('button').addEventListener('click', function() {
          resolve();
        });
        
        setTimeout(function() {
          if (overlay.parentElement) {
            overlay.remove();
            resolve();
          }
        }, 6000);
      });
    }
    
    // ÂÇ≥ÈÄÅÁïåÈù¢
    async function showTeleportUI(p) {
      return new Promise(function(resolve) {
        var modal = document.createElement('div');
        modal.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: white;
          padding: 30px;
          border-radius: 15px;
          box-shadow: 0 20px 60px rgba(0,0,0,0.4);
          z-index: 20000;
          max-width: 400px;
        `;
        
        var options = '';
        for (var i = 0; i < 40; i++) {
          var tile = tiles[i];
          var label = tile.name || tile.label || ('Ê†ºÂ≠ê ' + i);
          options += '<option value="' + i + '">' + i + ': ' + label + '</option>';
        }
        
        modal.innerHTML = `
          <h3 style="margin-bottom: 15px; color: #333;">üåÄ ÈÅ∏ÊìáÂÇ≥ÈÄÅÁõÆÊ®ô</h3>
          <select id="teleportTarget" style="width: 100%; padding: 10px; font-size: 16px; margin-bottom: 15px; border-radius: 8px; border: 2px solid #ddd;">
            ${options}
          </select>
          <button onclick="document.getElementById('teleportConfirm').click()" style="
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
          " id="teleportConfirm">Á¢∫ÂÆöÂÇ≥ÈÄÅ</button>
        `;
        
        document.body.appendChild(modal);
        
        document.getElementById('teleportConfirm').addEventListener('click', async function() {
          var target = parseInt(document.getElementById('teleportTarget').value);
          modal.remove();
          await moveTo(p, target, false);
          await resolveTile(p, 0);
          resolve();
        }, {once: true});
      });
    }
    
    // ‰∫§Êèõ‰ΩçÁΩÆÁïåÈù¢
    async function showSwapUI(p) {
      return new Promise(function(resolve) {
        var modal = document.createElement('div');
        modal.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: white;
          padding: 30px;
          border-radius: 15px;
          box-shadow: 0 20px 60px rgba(0,0,0,0.4);
          z-index: 20000;
          max-width: 400px;
        `;
        
        var options = '';
        state.players.forEach(function(player, idx) {
          if (idx !== state.cur && player.alive) {
            options += '<option value="' + idx + '">' + player.name + ' (‰ΩçÁΩÆ: ' + player.pos + ')</option>';
          }
        });
        
        modal.innerHTML = `
          <h3 style="margin-bottom: 15px; color: #333;">üîÑ ÈÅ∏Êìá‰∫§ÊèõÂ∞çË±°</h3>
          <select id="swapTarget" style="width: 100%; padding: 10px; font-size: 16px; margin-bottom: 15px; border-radius: 8px; border: 2px solid #ddd;">
            ${options}
          </select>
          <button onclick="document.getElementById('swapConfirm').click()" style="
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
          " id="swapConfirm">Á¢∫ÂÆö‰∫§Êèõ</button>
        `;
        
        document.body.appendChild(modal);
        
        document.getElementById('swapConfirm').addEventListener('click', async function() {
          var targetIdx = parseInt(document.getElementById('swapTarget').value);
          var targetPlayer = state.players[targetIdx];
          var tempPos = p.pos;
          modal.remove();
          
          await moveTo(p, targetPlayer.pos, false);
          await moveTo(targetPlayer, tempPos, false);
          
          log(p.name + ' Ëàá ' + targetPlayer.name + ' ‰∫§Êèõ‰∫Ü‰ΩçÁΩÆ', true);
          await resolveTile(p, 0);
          resolve();
        }, {once: true});
      });
    }
    
        async function moveTo(p, idx, passGoCredit){ 
          var startPos = p.pos;
          while (p.pos!==idx){ 
            p.pos=(p.pos+1)%40; 
            // Âè™ÊúâÁï∂Ëµ∑Èªû‰∏çÊòØÁõÆÁöÑÂú∞ÊôÇÔºåÁ∂ìÈÅéËµ∑ÈªûÊâçÂä†Èå¢
            if (p.pos===0 && passGoCredit && idx !== 0){ 
              var bonus=START_SALARY; 
              var bi=state.bonusNextGo.indexOf(p.id); 
              if (bi>=0){ bonus+=3300; state.bonusNextGo.splice(bi,1); } 
              p.cash+=bonus; 
              renderPlayers(); 
              log('üíµ '+p.name+' Á∂ìÈÅéËµ∑ÈªûÔºåÈ†ò $'+bonus, !p.isAI); 
            } 
            renderTokens(); 
            await sleep(80); 
          } 
        }
    async function moveToNearest(p, types, diceTotal, thenResolve, doubleRentOnStation){
      var i=p.pos; while (true){ i=(i+1)%40; var t=tiles[i]; if (types.indexOf(t.type)>=0){ await moveTo(p, i, true);
        if (thenResolve){ if (t.type==="UTILITY") await onLandUtility(p, t, diceTotal); else if (t.type==="STATION"){ var ownerIdx=ownerOf(t.idx); if (doubleRentOnStation && ownerIdx>=0 && ownerIdx!==state.cur){ var owner=state.players[ownerIdx]; if (owner.mortgaged.indexOf(t.idx)<0){ var ownerStations=[5,15,25,35].filter(function(s){ return owner.properties.indexOf(s)>=0 && owner.mortgaged.indexOf(s)<0; }).length; var rent=STATION_RENTS[clamp(ownerStations-1,0,3)]; await payToPlayer(p, owner, rent*2, 'ÈõôÂÄçËªäÁ´ôÁßüÈáëÔºàÊ©üÊúÉÂç°Ôºâ„Ää'+t.name+'„Äã'); return; } } await onLandStation(p, t); } } return; } } }
    async function moveBack(p, steps){ for (var i=0;i<steps;i++){ p.pos=(p.pos-1+40)%40; renderTokens(); await sleep(80); } }

    // ---- Áõ£ÁçÑ ----
    function showJailOptions(p){
      if (p.isAI) return;
      var canPay=p.cash>=JAIL_FINE;
      var html='<p>‰Ω†Âú®ÁçÑ‰∏≠ÔºåÂèØÈÅ∏ÊìáÔºö</p><ul><li>ÊîØ‰ªò $'+JAIL_FINE+' Á´ãÂç≥Âá∫ÁçÑ‰∏¶Êì≤È™∞</li><li>'+(p.outCard>0?'‰ΩøÁî® 1 ÂºµÂá∫ÁçÑÂç°':'ÂòóË©¶Êì≤Âá∫ÈõôÈ™∞ÔºàÊúÄÂ§ö 3 ÂõûÂêàÔºâ')+'</li></ul><div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;"><button id="jPay" '+(canPay?'':'disabled')+' class="ok">‰ªò‰øùÈáãÈáë</button>'+(p.outCard>0?'<button id="jCard" class="primary">‰ΩøÁî®Âá∫ÁçÑÂç°</button>':'')+'<button id="jTry" class="primary">ÂòóË©¶Êì≤È™∞</button></div>';
      showModal(html,false).then(function(){});
      var jPay=document.getElementById('jPay'); if (jPay) jPay.addEventListener('click', async function(){ await payToBank(p,JAIL_FINE,'‰øùÈáãÈáë'); if (!p.alive) return; p.inJail=false; p.jailTurns=0; document.getElementById('modal').classList.add('hidden'); await onRoll(); }, {once:true});
      var jCard=document.getElementById('jCard'); if (jCard) jCard.addEventListener('click', async function(){ if (p.outCard>0){ p.outCard--; p.inJail=false; p.jailTurns=0; renderPlayers(); document.getElementById('modal').classList.add('hidden'); await onRoll(); } }, {once:true});
      var jTry=document.getElementById('jTry'); if (jTry) jTry.addEventListener('click', async function(){ document.getElementById('modal').classList.add('hidden'); var d=rollDice(), d1=d[0], d2=d[1], dbl=d1===d2; if (dbl){ p.inJail=false; p.jailTurns=0; log(p.name+' Êì≤Âá∫ÈõôÈ™∞ÔºåÂá∫ÁçÑ‰∏¶ÁßªÂãï '+(d1+d2)+' Ê≠•„ÄÇ', !p.isAI); await moveSteps(p, d1+d2); await resolveTile(p, d1+d2); document.getElementById('btnEnd').disabled=false; } else { p.jailTurns++; log(p.name+' Êú™Êì≤Âá∫ÈõôÈ™∞ÔºàÁ¨¨ '+p.jailTurns+'/3 ÂõûÂêàÔºâ„ÄÇ', !p.isAI); if (p.jailTurns>=3){ await payToBank(p, JAIL_FINE, '‰øùÈáãÈáë'); if (!p.alive){ document.getElementById('btnEnd').disabled=false; return; } p.inJail=false; p.jailTurns=0; await onRoll(); } else { document.getElementById('btnEnd').disabled=false; } } }, {once:true});
    }

    // ---- Ë≥áÁî¢Èù¢ÊùøÔºàÂª∫Â±ãÔºâ ----
    function showAssets(){
      var wrap=document.getElementById('assetsBody'); var me=state.players[state.cur];
      var rows = [];
      me.properties.forEach(function(idx){
        var t=tiles[idx];
        var mort = me.mortgaged.indexOf(idx)>=0;
        var hc = houseCount(idx);
        var canB = canBuildHere(me, idx);
        var canS = canSellHouseHere(me, idx);
        var cost = buildCost(idx);
        rows.push('<tr><td>'+t.name+'</td><td>'+(t.group||'-')+'</td><td>'+(mort?'ÊäµÊäº':'Ê≠£Â∏∏')+'</td><td>'+hc+(hc===5?'Ôºàüè®Ôºâ':'')+'</td><td>$'+cost+'</td><td><button data-op="build" data-idx="'+idx+'" '+(canB?'':'disabled')+'>ÔºãÂª∫Â±ã</button><button data-op="sell" data-idx="'+idx+'" '+(canS?'':'disabled')+'>ÔºçË≥£Â±ã</button>'+(mort?'' : ' <button data-op="mortgage" data-idx="'+idx+'">ÊäµÊäº</button>')+(mort?(' <button data-op="unmortgage" data-idx="'+idx+'">Ë¥ñÂõû</button>'):'')+'</td></tr>');
      });
      var html = '<table class="asset-table"><thead><tr><th>Âú∞Âêç</th><th>Ëâ≤ÁµÑ</th><th>ÁãÄÊÖã</th><th>ÊàøÊï∏</th><th>Âª∫Â±ãË≤ª</th><th>Êìç‰Ωú</th></tr></thead><tbody>'+rows.join('')+'</tbody></table>';
      wrap.innerHTML = html;
      wrap.querySelectorAll('button[data-op]').forEach(function(btn){
        btn.addEventListener('click', function(){
          var op = btn.getAttribute('data-op'); var idx = Number(btn.getAttribute('data-idx'));
          if (op==='build'){ tryBuild(me, idx); }
          else if (op==='sell'){ trySellHouse(me, idx); }
          else if (op==='mortgage'){ doMortgage(me, idx); }
          else if (op==='unmortgage'){ doUnmortgage(me, idx); }
          showAssets(); renderPlayers(); updateOwners(); renderHouses();
        });
      });
      document.getElementById('assetsPanel').classList.remove('hidden');
    }
    function tryBuild(p, idx){
      if (!canBuildHere(p, idx)) return;
      var cost = buildCost(idx);
      if (p.cash < cost){ log('ÁèæÈáë‰∏çË∂≥ÔºåÁÑ°Ê≥ïÂª∫Â±ã„ÄÇ', !p.isAI); return; }
      p.cash -= cost; state.houses[idx] = houseCount(idx)+1;
      state.hasUpgradedThisTurn = true; // Ë®òÈåÑÊú¨ÂõûÂêàÂ∑≤ÂçáÁ¥ö
      renderPlayers(); renderHouses(); log('üè† '+p.name+' Âú®„Ää'+tiles[idx].name+'„ÄãÂª∫ÈÄ† 1 Ê£üÔºàÁèæÊúâ '+houseCount(idx)+'Ôºâ', !p.isAI);
    }
    function trySellHouse(p, idx){
      if (!canSellHouseHere(p, idx)) return;
      state.houses[idx] = houseCount(idx)-1;
      var val = sellValue(idx); p.cash += val;
      renderPlayers(); renderHouses(); log('üîß '+p.name+' Ë≥£Âá∫ 1 Ê£üÔºà„Ää'+tiles[idx].name+'„ÄãÔºâÔºåÂõûÊî∂ $'+val, !p.isAI);
    }

    // ---- Âç°ÁâåÂúñÈëë ----
    function showCardCollection() {
      var chanceCards = state.cardCollection.chance;
      var chestCards = state.cardCollection.chest;
      
      var chanceTotal = Object.keys(chanceCards).length;
      var chestTotal = Object.keys(chestCards).length;
      
      var chanceHTML = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">';
      
      Object.keys(chanceCards).forEach(function(key) {
        var item = chanceCards[key];
        var card = item.card;
        var rarityColors = {
          common: '#a8b2d1',
          rare: '#4facfe',
          epic: '#fa709a'
        };
        var color = rarityColors[card.rarity || 'common'];
        
        chanceHTML += `
          <div style="background: ${color}; padding: 15px; border-radius: 10px; color: white; text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            <div style="font-size: 40px; margin-bottom: 8px;">${card.emoji || 'üé¥'}</div>
            <div style="font-size: 14px; font-weight: bold; margin-bottom: 5px;">${card.text.split('Ôºö')[0].split('Ôºå')[0]}</div>
            <div style="font-size: 11px; opacity: 0.9;">Â∑≤ÊäΩÂèñ ${item.count} Ê¨°</div>
          </div>
        `;
      });
      chanceHTML += '</div>';
      
      var chestHTML = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">';
      
      Object.keys(chestCards).forEach(function(key) {
        var item = chestCards[key];
        var card = item.card;
        var rarityColors = {
          common: '#a8b2d1',
          rare: '#4facfe',
          epic: '#fa709a'
        };
        var color = rarityColors[card.rarity || 'common'];
        
        chestHTML += `
          <div style="background: ${color}; padding: 15px; border-radius: 10px; color: white; text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            <div style="font-size: 40px; margin-bottom: 8px;">${card.emoji || 'üé¥'}</div>
            <div style="font-size: 14px; font-weight: bold; margin-bottom: 5px;">${card.text.split('Ôºö')[0].split('Ôºå')[0]}</div>
            <div style="font-size: 11px; opacity: 0.9;">Â∑≤ÊäΩÂèñ ${item.count} Ê¨°</div>
          </div>
        `;
      });
      chestHTML += '</div>';
      
      var html = `
        <div style="max-height: 70vh; overflow-y: auto;">
          <h2 style="color: #333; margin-bottom: 10px;">üìö Âç°ÁâåÂúñÈëë</h2>
          <div style="display: flex; gap: 20px; margin-bottom: 20px; font-size: 14px; color: #666;">
            <div>Ê©üÊúÉÂç°Êî∂ÈõÜÔºö${chanceTotal} Á®Æ</div>
            <div>ÂëΩÈÅãÂç°Êî∂ÈõÜÔºö${chestTotal} Á®Æ</div>
          </div>
          
          <h3 style="color: #667eea; margin-top: 20px;">üé≤ Ê©üÊúÉÂç°</h3>
          ${chanceHTML}
          
          <h3 style="color: #f5576c; margin-top: 30px;">üÄ† ÂëΩÈÅãÂç°</h3>
          ${chestHTML}
        </div>
        <button onclick="document.getElementById('modal').classList.add('hidden')" style="
          margin-top: 20px;
          padding: 12px 30px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border: none;
          border-radius: 10px;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
          width: 100%;
        ">ÈóúÈñâ</button>
      `;
      
      showModal(html, false);
    }
    
    // ---- AI Á≠ñÁï•ÔºàÂçáÁ¥öÁâàÊú¨Ôºâ ----
    function aiShouldBuyProperty(p, t){
      var reserve = 500;
      var willHave = p.cash - t.price;
      var same = tiles.filter(function(x){ return x.type==="PROPERTY" && x.group===t.group; });
      var owned = same.filter(function(x){ return p.properties.indexOf(x.idx)>=0 && p.mortgaged.indexOf(x.idx)<0; }).length;
      var total = same.length;
      if (owned+1 === total) return p.cash >= t.price; // ÊπäÊªøËâ≤ÁµÑ
      return willHave >= reserve;
    }
    function aiShouldBuyStation(p){ return p.cash >= 600 || [5,15,25,35].some(function(s){ return p.properties.indexOf(s)>=0; }); }
    function aiShouldBuyUtility(p){ return p.cash >= 400 || [12,28].some(function(u){ return p.properties.indexOf(u)>=0; }); }

    async function aiTurn(){
      // Ê®°Êì¨ÊÄùËÄÉÊôÇÈñì
      await sleep(300 + Math.random() * 700);
      var p=state.players[state.cur];
      await sleep(400);
      // Áõ£ÁçÑÈÇèËºØÊ≤øÁî®
      if (p.inJail){
        if (p.jailTurns<2){
          var d=rollDice(), d1=d[0], d2=d[1], dbl=d1===d2;
          if (dbl){ p.inJail=false; p.jailTurns=0; log(p.name+' Êì≤Âá∫ÈõôÈ™∞Âá∫ÁçÑÔºåÁßªÂãï '+(d1+d2)+' Ê≠•„ÄÇ', true); await moveSteps(p, d1+d2); await resolveTile(p, d1+d2); }
          else { p.jailTurns++; log(p.name+' ÂòóË©¶Â§±ÊïóÔºàÁ¨¨ '+p.jailTurns+'/3 ÂõûÂêàÔºâ', true); }
        } else {
          await ensureCash(p, JAIL_FINE);
          if (!p.alive){ endTurn(); return; }
          await payToBank(p, JAIL_FINE, "‰øùÈáãÈáë");
          if (!p.alive){ endTurn(); return; }
          p.inJail=false; p.jailTurns=0;
          var res = await onRoll();
          if (res && res.again){ await sleep(400); await onRoll(); }
          await aiUnmortgageIfRich(p);
          aiAutoBuild(p);
          endTurn(); return;
        }
        await aiUnmortgageIfRich(p);
        aiAutoBuild(p);
        endTurn(); return;
      }
      // ÊôÆÈÄöÂõûÂêà
      var r = await onRoll();
      if (r && r.again){ await sleep(400); r = await onRoll(); if (r && r.again){ await sleep(400); await onRoll(); } }
      await aiUnmortgageIfRich(p);
      aiAutoBuild(p);
      endTurn();
    }
    async function aiUnmortgageIfRich(p){
      var reserve = 600;
      var list = p.mortgaged.slice().sort(function(a,b){ return getPrice(tiles[a]) - getPrice(tiles[b]); });
      for (var i=0;i<list.length;i++){
        var idx=list[i]; var cost=Math.floor(getPrice(tiles[idx])*0.5*1.1);
        if (p.cash - cost >= reserve) doUnmortgage(p, idx);
      }
    }
    function aiAutoBuild(p){
      // Ëã•ÊåÅÊúâÊï¥ÁµÑ‰∏îÁèæÈáë>1000ÔºåÂÑ™ÂÖàÊääË©≤ÁµÑÂπ≥ÂùáÂª∫Âà∞ 2 Ê£üÔºõ‰πãÂæåÂÜçË°ù 3~4ÔºåÊúÄÂæåÊóÖÈ§®„ÄÇ
      if (p.cash < 1000) return;
      var groups = {};
      p.properties.forEach(function(idx){ var g=tiles[idx].group; if (!g) return; groups[g]=groups[g]||[]; groups[g].push(idx); });
      Object.keys(groups).forEach(function(g){
        var slots = groups[g];
        if (!slots.every(function(idx){ return p.properties.indexOf(idx)>=0 && p.mortgaged.indexOf(idx)<0; })) return;
        var target = Math.min(4, Math.floor((p.cash-800)/buildCost(slots[0]))>=slots.length ? 2 : 1);
        // ÂÖàÂùáË°°Âª∫Âà∞ target
        for (var level=1; level<=target; level++){
          for (var i=0;i<slots.length;i++){
            var idx=slots[i];
            if (p.cash < buildCost(idx)) return;
            if (canBuildHere(p, idx) && houseCount(idx) < level){ tryBuild(p, idx); }
          }
        }
        // ÊúâÈå¢ÁπºÁ∫åÂæÄ‰∏äÊàñÊóÖÈ§®
        for (var round=0; round<10; round++){
          var progressed=false;
          for (var i=0;i<slots.length;i++){
            var idx=slots[i]; if (p.cash < buildCost(idx)) return;
            if (canBuildHere(p, idx) && houseCount(idx) < 5){ tryBuild(p, idx); progressed=true; }
          }
          if (!progressed) break;
        }
      });
    }

    // ---- ‰∫ã‰ª∂Á∂ÅÂÆöËàáÂ≠òÊ™î ----
    document.getElementById('btnRoll').addEventListener('click', onRoll);
    document.getElementById('btnEnd').addEventListener('click', endTurn);
    document.getElementById('btnBuy').addEventListener('click', function(){ if (!state.awaitingBuy) return; var p=state.players[state.cur]; var t=tiles[p.pos]; var price=(t.type==="PROPERTY")?t.price:(t.type==="STATION"?6600:5000); buyProperty(p, t.idx, price); state.awaitingBuy=false; $('#btnBuy').disabled=true; $('#btnSkip').disabled=true; $('#btnEnd').disabled=false; });
    document.getElementById('btnSkip').addEventListener('click', function(){ state.awaitingBuy=false; $('#btnBuy').disabled=true; $('#btnSkip').disabled=true; $('#btnEnd').disabled=false; });
    document.getElementById('btnReset').addEventListener('click', function(){ 
      showPlayerCountSelection();
    });
    document.getElementById('btnAssets').addEventListener('click', showAssets);
    document.getElementById('btnCollection').addEventListener('click', showCardCollection);
    document.getElementById('btnBuild').addEventListener('click', function(){ 
      var p = state.players[state.cur];
      var currentTile = tiles[p.pos];
      
      // Ê™¢Êü•ÊòØÂê¶Ë∏©Âú®Ëá™Â∑±ÁöÑÂú∞Áî¢‰∏ä
      if (currentTile.type !== "PROPERTY") {
        alert('ÂøÖÈ†àÁ´ôÂú®Ëá™Â∑±ÁöÑÂú∞Áî¢‰∏äÊâçËÉΩÂçáÁ¥öÊàøÂ±ãÔºÅ');
        return;
      }
      
      if (p.properties.indexOf(p.pos) < 0) {
        alert('ÈÄô‰∏çÊòØ‰Ω†ÁöÑÂú∞Áî¢ÔºÅ');
        return;
      }
      
      // È°ØÁ§∫Áï∂ÂâçÂú∞Áî¢ÁöÑÂçáÁ¥öÈÅ∏È†Ö
      showBuildUI(p, p.pos);
    });
    
    // ---- ÂñÆÂÄãÂú∞Áî¢ÂçáÁ¥öÁïåÈù¢ ----
    function showBuildUI(p, idx){
      var t = tiles[idx];
      var mort = p.mortgaged.indexOf(idx) >= 0;
      var h = houseCount(idx);
      var cost = buildCost(idx);
      var canBuild = !mort && h < 5 && canBuildHere(p, idx) && p.cash >= cost;
      var canSell = h > 0;
      
      // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Êú¨ÂõûÂêàË≥ºË≤∑
      if (state.justBought.indexOf(idx) >= 0) {
        alert('Êú¨ÂõûÂêàÂâõË≥ºË≤∑ÁöÑÂú∞Áî¢ÁÑ°Ê≥ïÁ´ãÂç≥ÂçáÁ¥öÔºåË´ã‰∏ãÊ¨°Ëµ∞Âà∞ÊôÇÂÜçÂçáÁ¥öÔºÅ');
        return;
      }
      
      // Ê™¢Êü•Êú¨ÂõûÂêàÊòØÂê¶Â∑≤Á∂ìÂçáÁ¥öÈÅé
      if (state.hasUpgradedThisTurn) {
        alert('Êú¨ÂõûÂêàÂ∑≤Á∂ìÂçáÁ¥öÈÅé‰∏ÄÊ¨°ÔºåË´ã‰∏ãÂõûÂêàÂÜçÂçáÁ¥öÔºÅ');
        return;
      }
      
      var html = '<h3>üè† ' + t.name + ' ÊàøÂ±ãÁÆ°ÁêÜ</h3>';
      html += '<p>Áï∂ÂâçÊàøÂ±ãÊï∏Ôºö' + (h === 5 ? 'ÊóÖÈ§®' : h + ' Ê£ü') + '</p>';
      html += '<p>‰Ω†ÁöÑÁèæÈáëÔºö$' + p.cash + '</p>';
      
      if (mort) {
        html += '<p style="color:orange;">Ê≠§Âú∞Áî¢Â∑≤ÊäµÊäºÔºåÁÑ°Ê≥ïÂª∫ÈÄ†ÊàøÂ±ã</p>';
      } else {
        html += '<p>Âª∫ÈÄ†Ë≤ªÁî®Ôºö$' + cost + '</p>';
        html += '<p>Âá∫ÂîÆÂÉπÂÄºÔºö$' + sellValue(idx) + '</p>';
      }
      
      html += '<div style="display:flex;gap:8px;margin-top:12px;">';
      if (canBuild) {
        html += '<button id="buildBtn" class="ok">Âª∫ÈÄ† +1</button>';
      }
      if (canSell) {
        html += '<button id="sellBtn" class="danger">Âá∫ÂîÆ -1</button>';
      }
      html += '<button id="closeBtn">ÈóúÈñâ</button>';
      html += '</div>';
      
      showModal(html, false);
      
      var buildBtn = document.getElementById('buildBtn');
      if (buildBtn) {
        buildBtn.addEventListener('click', function(){
          tryBuild(p, idx);
          document.getElementById('modal').classList.add('hidden');
          renderPlayers();
          updateOwners();
          renderHouses();
        });
      }
      
      var sellBtn = document.getElementById('sellBtn');
      if (sellBtn) {
        sellBtn.addEventListener('click', function(){
          trySellHouse(p, idx);
          document.getElementById('modal').classList.add('hidden');
          renderPlayers();
          updateOwners();
          renderHouses();
        });
      }
      
      var closeBtn = document.getElementById('closeBtn');
      if (closeBtn) {
        closeBtn.addEventListener('click', function(){
          document.getElementById('modal').classList.add('hidden');
        });
      }
    }
    document.getElementById('btnCloseAssets').addEventListener('click', function(){ document.getElementById('assetsPanel').classList.add('hidden'); });

    function buyProperty(p, idx, priceOverride){ var t=tiles[idx]; var price=priceOverride!=null?priceOverride:(t.type==="PROPERTY"?t.price:(t.type==="STATION"?6600:5000)); if (p.cash<price){ log('Ë≥áÈáë‰∏çË∂≥ÔºåÁÑ°Ê≥ïË≥ºË≤∑„ÄÇ', !p.isAI); return; } p.cash-=price; p.properties.push(idx); state.justBought.push(idx); updateOwners(); renderPlayers(); log('üìù '+p.name+' ‰ª• $'+price+' Ë≥ºÂæó„Ää'+(t.name||t.label)+'„Äã', !p.isAI); }

    document.getElementById('btnSave').addEventListener('click', function(){ try{ var save = JSON.stringify(state); localStorage.setItem("tycoon_save_v23", save); log("üíæ Â∑≤Â≠òÊ™îÔºàv23Ôºâ„ÄÇ", false); }catch(e){ diagERR("Â≠òÊ™îÂ§±ÊïóÔºö"+(e&&e.message||e)); } });
    document.getElementById('btnLoad').addEventListener('click', function(){ try{ var s = localStorage.getItem("tycoon_save_v23"); if (!s) { alert("Ê≤íÊúâ v23 Â≠òÊ™î„ÄÇ"); return; } var obj = JSON.parse(s); state.cur = obj.cur|0; state.dice = obj.dice||[0,0]; state.doublesInRow = obj.doublesInRow|0; state.awaitingBuy = false; state.mustEnd = false; state.players = (obj.players||[]).map(function(p){ return { id: p.id||uuid(), name: p.name, isAI: !!p.isAI, color: p.color, cash: p.cash|0, pos: p.pos|0, inJail: !!p.inJail, jailTurns: p.jailTurns|0, outCard: p.outCard|0, properties: p.properties||[], mortgaged: p.mortgaged||[], alive: p.alive!==false, rentBonusTemp: p.rentBonusTemp|0 }; }); state.bonusNextGo = obj.bonusNextGo||[]; state.houses = obj.houses||{}; renderPlayers(); buildBoard(); renderTokens(); document.getElementById('btnRoll').disabled = state.players[state.cur].isAI; document.getElementById('btnEnd').disabled = true; log("üìÇ Â∑≤ËÆÄÂèñ v23 Â≠òÊ™î„ÄÇ", false); }catch(e){ diagERR("ËÆÄÊ™îÂ§±ÊïóÔºö"+(e&&e.message||e)); } });

    // Ëµ∑Âßã
    // initPlayers(); // ÊîπÁÇ∫ÈªûÊìäÊñ∞ÈÅäÊà≤ÊâçÈñãÂßã
    setTimeout(addButtonSounds, 500);
    buildBoard();
    renderTokens();
    document.getElementById('btnEnd').disabled = true;
  } // main ÂáΩÊï∏ÁµêÊùü
})();
  </script>
  <script>
  // Èù¢ÊùøÊäòÁñäÂäüËÉΩ
  (function(){
    const panel = document.getElementById('centerPanel');
    const toggle = document.getElementById('panelToggle');
    const content = document.getElementById('panelContent');
    
    if (toggle && panel && content) {
      toggle.addEventListener('click', function() {
        panel.classList.toggle('collapsed');
        content.classList.toggle('hidden');
        toggle.textContent = panel.classList.contains('collapsed') ? 'Â±ïÈñã' : 'Êî∂Ëµ∑';
      });
    }
  })();
  
  // ÊàøÂ±ãÁ≠âÁ¥öÈ°ØÁ§∫ÂäüËÉΩ
  (function(){
    // Á≠âÂæÖ DOM ÂÆåÂÖ®ËºâÂÖ•
    if (typeof window.updateLevelBadges === 'undefined') {
      window.updateLevelBadges = function(){
        // ÁßªÈô§ÊâÄÊúâÁèæÊúâÁöÑÁ≠âÁ¥öÊ®ôË®ò
        var badges = document.querySelectorAll('.level-badge');
        badges.forEach(function(el){ el.remove(); });
        
        // ÈÅçÊ≠∑ÊâÄÊúâÊúâÊàøÂ±ãÁöÑÂú∞Áî¢
        if (typeof state === 'undefined' || !state.houses) return;
        
        Object.keys(state.houses).forEach(function(k){
          var idx = Number(k);
          var level = state.houses[k] | 0;
          if (!level) return;
          
          // ÊâæÂà∞Â∞çÊáâÁöÑÊ†ºÂ≠ê
          var pos = idxToCoord(idx);
          var cell = document.querySelector('#board > .tile[style*="grid-row: '+(pos.r+1)+';"[style*="grid-column: '+(pos.c+1)+';"');
          if (!cell) return;
          
          // ÂâµÂª∫Á≠âÁ¥öÊ®ôË®ò
          var badge = document.createElement('div');
          badge.className = 'level-badge';
          
          if (level === 5) {
            badge.textContent = 'LV5';
            badge.classList.add('hotel');
          } else {
            badge.textContent = 'LV' + level;
          }
          
          cell.appendChild(badge);
        });
      };
      
      // Ë¶ÜËìãÂéüÂßãÁöÑ renderHouses ÂáΩÊï∏
      if (typeof window.originalRenderHouses === 'undefined' && typeof renderHouses !== 'undefined') {
        window.originalRenderHouses = renderHouses;
        window.renderHouses = function() {
          window.originalRenderHouses();
          window.updateLevelBadges();
        };
      }
    }
  })();
  </script>

</body>
</html>